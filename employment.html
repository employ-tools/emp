<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>就職状況管理</title>

<style>
body { font-family: sans-serif; margin: 16px; }
#app { display: none; }

table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; }
th { background: #f0f0f0; }
/* テーブル行がクリック可能であることを示すカーソル */
#employment-table tr { cursor: pointer; } 

.input-text { font-size: 16px; padding: 4px; width: 300px; margin-bottom: 6px; }
.input-date { font-size: 16px; padding: 4px; }

/* ボタンの共通スタイルを調整 */
.big-button { 
  font-size: 18px; 
  padding: 10px 20px; 
  margin-right: 10px; 
  border-radius: 6px; 
  border: none; 
  cursor: pointer; 
  background:#4CAF50; 
  color:#fff; 
  margin-bottom: 5px; 
}
.delete-button { background:#e74c3c; }
.manage-button { background: #3498db; }
/* フィルターボタンの選択時のスタイル */
.active-filter { background-color: #333 !important; }

#loginBox { max-width: 420px; margin: 80px auto; padding: 24px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }

/* modal */
#companyModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); }
#companyModal .inner { background:#fff; max-width:600px; margin:80px auto; padding:16px; border-radius:8px; }
</style>
</head>
<body>

<div id="loginBox">
  <h2>ログイン</h2>
  <form onsubmit="tryLogin();return false;">
    <input id="loginId" class="input-text" placeholder="学籍番号 / 管理者ID">
    <input id="pwInput" type="password" class="input-text" placeholder="管理者パスワード">
    <br>
    <button class="big-button" type="submit">ログイン</button>
  </form>
  <p id="loginErr" style="color:red;"></p>
</div>

<div id="app">
<h1>就職状況管理</h1>
<p id="welcomeMessage" style="margin-top: 0; font-size: 1.1em; font-weight: bold;"></p>

<div>
  <input id="searchBox" class="input-text" placeholder="学籍番号で検索">
  <button id="searchButton" class="big-button" onclick="searchEmployment()">検索</button>
  <button class="big-button" onclick="clearAll()">クリア</button>
  <button id="companyManageButton" class="big-button manage-button" onclick="openCompanyManager()">会社登録</button>
</div>

<hr>
<div id="editSection" style="display:none;">
    <h3>登録 / 編集</h3>

    生徒<br>
    <input id="student" class="input-text"><br>

    会社名<br>
    <input id="companyName" class="input-text" readonly>
    <button class="big-button" onclick="openCompanyModal()">選択</button><br>

    状況<br>
    <select id="statusSelect" class="input-text">
      <option>説明会</option>
      <option>書類選考応募</option>
      <option>１次面接予定</option>
      <option>２次面接予定</option>
      <option>最終面接予定</option>
      <option>内々定</option>
      <option>内定</option>
      <option>不採用</option>
    </select><br>

    日付<br>
    <input type="date" id="date" class="input-date"><br><br>

    <button class="big-button" onclick="addEmployment()">追加</button>
    <button class="big-button" onclick="updateEmployment()">編集</button>
    <button id="deleteButton" class="big-button delete-button" onclick="deleteEmployment()">削除</button>
</div>
<hr id="editSectionHr" style="display:none;">

<button class="big-button" onclick="showAddForm()">新規追加</button>

<hr>
<div id="classFilterContainer" style="margin-bottom: 15px;">
  </div>
<hr>

<table>
<thead>
<tr><th>学籍番号</th><th>名前</th><th>会社名</th><th>状況</th><th>日付</th></tr>
</thead>
<tbody id="employment-table"></tbody>
</table>
</div>

<div id="companyModal">
  <div class="inner">
    <h3>会社選択</h3>
    <input id="companySearch" class="input-text" placeholder="会社名検索">
    <table>
      <tbody id="companyList"></tbody>
    </table>
    <button class="big-button" onclick="closeCompanyModal()">閉じる</button>
  </div>
</div>

<script>
const API_EMP = "https://69391958c8d59937aa067b4c.mockapi.io/employment";
const API_COMPANY = "https://69391958c8d59937aa067b4c.mockapi.io/company";

let employment=[];
let companies=[];
let selectedId=null;

let studentsList = []; 
let studentsMap = new Map();
let studentClassMap = new Map();
let classKeys = [];
let currentFilterClass = 'ALL'; 

let statusColors = {};

window.loginRole = null; 
window.loginStudentId = null;
window.loginStudentName = null;

async function loadStatusColors() {
    try {
        const response = await fetch('status_colors.json');
        if (!response.ok) throw new Error('Failed to load status_colors.json: ' + response.statusText);
        statusColors = await response.json();
        console.log("Status colors loaded successfully.");
    } catch (error) {
        console.error("Error loading status colors data.", error);
    }
}

async function loadStudents() {
  try {
    const response = await fetch('students.json');
    if (!response.ok) throw new Error('Failed to load students.json: ' + response.statusText);
    
    const studentData = await response.json();

    studentsList = [];
    studentsMap = new Map();
    studentClassMap = new Map(); 
    classKeys = []; 

    for (const classKey in studentData) {
      if (Array.isArray(studentData[classKey])) {
        classKeys.push(classKey); 
        for (const student of studentData[classKey]) {
            studentsList.push(student.id);
            studentsMap.set(student.id, student.name); 
            studentClassMap.set(student.id, classKey); 
        }
      }
    }
    console.log("Students loaded successfully.");
  } catch (error) {
    console.error("Error loading students data.", error);
    document.getElementById("loginErr").textContent = "エラー: 学生データの読み込みに失敗しました。Webサーバー経由でアクセスしているか確認してください。";
  }
}

function updateUIVisibility() {
    const isStudent = window.loginRole === "student";

    const searchBox = document.getElementById("searchBox");
    const searchButton = document.getElementById("searchButton");
    const deleteButton = document.getElementById("deleteButton");
    const classFilterContainer = document.getElementById("classFilterContainer"); 
    const editSection = document.getElementById("editSection");
    const editSectionHr = document.getElementById("editSectionHr");

    if (searchBox) searchBox.style.display = isStudent ? "none" : "";
    if (searchButton) searchButton.style.display = isStudent ? "none" : "";
    if (deleteButton) deleteButton.style.display = isStudent ? "none" : "";
    
    if (classFilterContainer) classFilterContainer.style.display = isStudent ? "none" : "";
    
    if (window.loginRole === "admin") {
        editSection.style.display = 'none';
        editSectionHr.style.display = 'none';
    } else if (window.loginRole === "student") {
        editSection.style.display = 'block';
        editSectionHr.style.display = 'block';
    }
    
    displayWelcomeMessage();
}

function showAddForm() {
    const editSection = document.getElementById("editSection");
    const editSectionHr = document.getElementById("editSectionHr");
    
    document.getElementById("student").value = (window.loginRole === "student" ? window.loginStudentId : "");
    document.getElementById("companyName").value = "";
    document.getElementById("statusSelect").value = "説明会";
    document.getElementById("date").value = "";
    selectedId = null; 

    editSection.style.display = 'block';
    editSectionHr.style.display = 'block';
}

function displayWelcomeMessage() {
    const msgElement = document.getElementById("welcomeMessage");
    if (window.loginRole === "student" && window.loginStudentName) {
        msgElement.textContent = `こんにちは ${window.loginStudentName}さん`;
    } else {
        msgElement.textContent = ""; 
    }
}


async function tryLogin(){
  const loginId = document.getElementById("loginId").value.trim();
  const pwInput = document.getElementById("pwInput").value.trim();
  const loginErr = document.getElementById("loginErr");

  if (studentsList.length === 0) {
      await loadStudents();
      if (studentsList.length === 0) {
          return;
      }
  }
  
  if (pwInput === "admin" || pwInput === "管理者パスワード" || loginId.toLowerCase() === "admin") {
      loginErr.textContent = "";
      loginBox.style.display="none";
      app.style.display="block";
      window.loginRole = "admin";
      window.loginStudentId = loginId;
      window.loginStudentName = null; 
      
      updateUIVisibility();
      loadEmployment();
      loadCompanies();
      return;
  }

  if (studentsList.includes(loginId) && pwInput === "") {
      loginErr.textContent = "";
      loginBox.style.display="none";
      app.style.display="block";
      
      window.loginRole = "student";
      window.loginStudentId = loginId;
      window.loginStudentName = studentsMap.get(loginId);
      
      updateUIVisibility();
      loadEmployment();
      loadCompanies();
  } else {
      loginErr.textContent = "学籍番号または管理者パスワードが正しくありません。";
      document.getElementById("pwInput").value = "";
  }
}

function openCompanyManager() {
    window.open('company.html', '_blank');
}


function loadEmployment() {
  fetch(API_EMP)
    .then(r => r.json())
    .then(data => {
      const allData = data;
      
      employment = (window.loginRole === "student")
        ? allData.filter(e => e.student === window.loginStudentId)
        : allData; 

      if (window.loginRole === "admin") {
          currentFilterClass = 'ALL'; 
          renderClassFilters(); 
          renderTable(employment);
          document.getElementById("editSection").style.display = 'none';
          document.getElementById("editSectionHr").style.display = 'none';

      } else {
          renderTable(employment);
      }

      if (window.loginRole === "student") {
          document.getElementById("student").value = window.loginStudentId;
          document.getElementById("student").readOnly = true;
      } else {
          document.getElementById("student").readOnly = false;
      }
    });
}

// ★ 修正: renderTable関数に名前表示を追加
function renderTable(list){
  const tb=document.getElementById("employment-table");
  tb.innerHTML="";
  list.forEach(e=>{
    const tr=document.createElement("tr");
    tr.onclick=()=>selectRow(e.id);
    
    // 学生の名前を取得
    const studentName = studentsMap.get(e.student) || "不明"; 
    
    // 学籍番号と名前のセルを追加
    tr.innerHTML=`<td>${e.student}</td><td>${studentName}</td><td>${e.companyName}</td><td>${e.status}</td><td>${e.date||""}</td>`;

    const colorInfo = statusColors[e.status];
    if (colorInfo) {
        tr.style.backgroundColor = colorInfo.background;
        tr.style.color = colorInfo.text;
    }

    tb.appendChild(tr);
  });
}

function selectRow(id){
  selectedId=id;
  const e=employment.find(x=>x.id===id);
  
  document.getElementById("student").value=e.student;
  document.getElementById("companyName").value=e.companyName;
  document.getElementById("statusSelect").value=e.status;
  document.getElementById("date").value=e.date||"";

  if (window.loginRole === "admin" || window.loginRole === "student") {
      document.getElementById("editSection").style.display = 'block';
      document.getElementById("editSectionHr").style.display = 'block';
  }
}


function renderClassFilters() {
    const container = document.getElementById("classFilterContainer");
    if (!container || window.loginRole !== "admin") return;
    
    container.innerHTML = "";
    
    const allButton = document.createElement("button");
    allButton.textContent = "ALL";
    allButton.className = "big-button";
    if (currentFilterClass === 'ALL') {
        allButton.classList.add('active-filter');
    }
    allButton.onclick = () => filterByClass('ALL');
    container.appendChild(allButton);

    classKeys.forEach(key => {
        const button = document.createElement("button");
        button.textContent = key;
        button.className = "big-button";
        if (currentFilterClass === key) {
             button.classList.add('active-filter');
        }
        button.onclick = () => filterByClass(key);
        container.appendChild(button);
    });
}

function filterByClass(classKey) {
    if (window.loginRole !== "admin") return;

    currentFilterClass = classKey;
    renderClassFilters(); 

    let filteredEmployment = employment;

    if (classKey !== 'ALL') {
        const studentIdsInClass = Array.from(studentClassMap.entries())
            .filter(([id, cls]) => cls === classKey)
            .map(([id, cls]) => id);

        filteredEmployment = employment.filter(e => studentIdsInClass.includes(e.student));
    }

    renderTable(filteredEmployment);
}


function loadCompanies(){
  fetch(API_COMPANY).then(r=>r.json()).then(d=>{ companies=d; renderCompanyList(d); });
}

function addEmployment(){
  if (window.loginRole === "student" && student.value !== window.loginStudentId) {
      alert("学生は自分の就職状況のみを追加・編集できます。");
      return;
  }
  fetch(API_EMP,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({student:student.value,companyName:companyName.value,status:statusSelect.value,date:date.value})}).then(loadEmployment);
}

function updateEmployment(){
  if(!selectedId)return;
  if (window.loginRole === "student" && student.value !== window.loginStudentId) {
      alert("学生は自分の就職状況のみを追加・編集できます。");
      return;
  }
  fetch(`${API_EMP}/${selectedId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({student:student.value,companyName:companyName.value,status:statusSelect.value,date:date.value})}).then(loadEmployment);
}

function deleteEmployment(){
  if(!selectedId||!confirm("削除しますか？"))return;
  const e=employment.find(x=>x.id===selectedId);
  if (window.loginRole === "student" && e.student !== window.loginStudentId) {
      alert("学生は自分の就職状況のみを削除できます。");
      return;
  }
  fetch(`${API_EMP}/${selectedId}`,{method:"DELETE"}).then(loadEmployment);
}

function searchEmployment(){
  const k=searchBox.value.trim();
  if(!k)return renderTable(employment);
  
  let dataToSearch;
  if (window.loginRole === "admin" && currentFilterClass !== 'ALL') {
      const studentIdsInClass = Array.from(studentClassMap.entries())
            .filter(([id, cls]) => cls === currentFilterClass)
            .map(([id, cls]) => id);
      dataToSearch = employment.filter(e => studentIdsInClass.includes(e.student));
  } else {
      dataToSearch = (window.loginRole === "student") 
          ? employment.filter(e => e.student === window.loginStudentId)
          : employment;
  }

  // 検索は学籍番号に対して行われますが、表示は名前付きのテーブルを使用します
  renderTable(dataToSearch.filter(e=>e.student.includes(k)));
}

function clearAll(){
  searchBox.value=""; companyName.value=""; date.value=""; 
  if (window.loginRole === "admin") {
      filterByClass('ALL');
  } else {
      renderTable(employment);
  }
}

function openCompanyModal(){
  companyModal.style.display="block";
  renderCompanyList(companies);
}
function closeCompanyModal(){ companyModal.style.display="none"; }

companySearch.oninput=()=>{
  const k=companySearch.value.trim();
  renderCompanyList(!k?companies:companies.filter(c=>c.companyName.includes(k)));
};

function renderCompanyList(list){
  const tb=document.getElementById("companyList");
  tb.innerHTML="";
  list.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${c.companyName}</td>`;
    tr.onclick=()=>{ companyName.value=c.companyName; closeCompanyModal(); };
    tb.appendChild(tr);
  });
}

loadStudents();
loadStatusColors();
</script>
</body>
</html>