<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å°±è·çŠ¶æ³ç®¡ç† (Firestoreç‰ˆ)</title>

<style>
/* ... (ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã¯å¤‰æ›´ãªã—) ... */
body { font-family: sans-serif; margin: 16px; }
#app { display: none; }

table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; }
th { background: #f0f0f0; }
/* ãƒ†ãƒ¼ãƒ–ãƒ«è¡ŒãŒã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚«ãƒ¼ã‚½ãƒ« */
#employment-table tr { cursor: pointer; } 

.input-text { font-size: 16px; padding: 4px; width: 300px; margin-bottom: 6px; }
.input-date { font-size: 16px; padding: 4px; }

/* ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´ */
.big-button { 
  font-size: 18px; 
  padding: 10px 20px; 
  margin-right: 10px; 
  border-radius: 6px; 
  border: none; 
  cursor: pointer; 
  background:#4CAF50; 
  color:#fff; 
  margin-bottom: 5px; 
}
.delete-button { background:#e74c3c; }
.manage-button { background: #3498db; }
/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®é¸æŠæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.active-filter { background-color: #333 !important; }

#loginBox { max-width: 420px; margin: 80px auto; padding: 24px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }

/* modal */
#companyModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); }
#companyModal .inner { background:#fff; max-width:600px; margin:80px auto; padding:16px; border-radius:8px; }

/* å±¥æ­´ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
#historyList ul {
    list-style-type: none;
    padding-left: 0;
    margin: 0;
}
#historyList li {
    padding: 4px 8px;
    border-bottom: 1px dotted #ccc;
    font-size: 0.9em;
}
#historyList li:last-child {
    border-bottom: none;
}
</style>
</head>
<body>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<div id="loginBox">
  <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
  <form onsubmit="tryLogin();return false;">
    <input id="loginId" class="input-text" placeholder="å­¦ç±ç•ªå· / ç®¡ç†è€…ID">
    <input id="pwInput" type="password" class="input-text" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <br>
    <button class="big-button" type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </form>
  <p id="loginErr" style="color:red;"></p>
</div>

<div id="app">
<h1>å°±è·çŠ¶æ³ç®¡ç†</h1>
<p id="welcomeMessage" style="margin-top: 0; font-size: 1.1em; font-weight: bold;"></p>

<div>
  <input id="searchBox" class="input-text" placeholder="å­¦ç±ç•ªå·ã§æ¤œç´¢">
  <button id="searchButton" class="big-button" onclick="searchEmployment()">æ¤œç´¢</button>
  <button class="big-button" onclick="clearAll()">ã‚¯ãƒªã‚¢</button>
  <button id="companyManageButton" class="big-button manage-button" onclick="openCompanyManager()" style="display: none;">ä¼šç¤¾ç™»éŒ²</button>
</div>

<hr>
<div id="editSection" style="display:none;">
    <h3>ç™»éŒ² / ç·¨é›†</h3>

    ç”Ÿå¾’<br>
    <input id="student" class="input-text"><br>

    ä¼šç¤¾å<br>
    <input id="companyName" class="input-text" readonly>
    <button class="big-button" onclick="openCompanyModal()">é¸æŠ</button><br>

    çŠ¶æ³<br>
    <select id="statusSelect" class="input-text">
      <option>èª¬æ˜ä¼š</option>
      <option>æ›¸é¡é¸è€ƒå¿œå‹Ÿ</option>
      <option>ï¼‘æ¬¡é¢æ¥äºˆå®š</option>
      <option>ï¼’æ¬¡é¢æ¥äºˆå®š</option>
      <option>æœ€çµ‚é¢æ¥äºˆå®š</option>
      <option>å†…ã€…å®š</option>
      <option>å†…å®š</option>
      <option>ä¸æ¡ç”¨</option>
    </select><br>

    æ—¥ä»˜<br>
    <input type="date" id="date" class="input-date"><br><br>

    <button class="big-button" onclick="addEmployment()">è¿½åŠ </button>
    <button class="big-button" onclick="updateEmployment()">ç·¨é›†</button>
    <button id="deleteButton" class="big-button delete-button" onclick="deleteEmployment()">å‰Šé™¤</button>

    <div id="historyContainer" style="margin-top: 15px; border-top: 1px solid #ccc; padding-top: 10px; display: none;">
        <h4>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å±¥æ­´ 
            <span id="historyToggle" style="cursor: pointer; color: blue; font-size: 0.8em;">(è¡¨ç¤º/éè¡¨ç¤º)</span>
        </h4>
        <div id="historyList" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 5px; display: none;">
            </div>
    </div>
</div>
<hr id="editSectionHr" style="display:none;">


<button class="big-button manage-button" onclick="toggleBackupRestore()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / ãƒªã‚¹ãƒˆã‚¢ (ãƒˆã‚°ãƒ«)</button>

<div id="backupRestoreContainer" style="display: none;">
    <div id="backupRestoreSection" style="margin-top: 10px; margin-bottom: 20px; display: none;">
        <h3>ğŸ“Š ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / ãƒªã‚¹ãƒˆã‚¢</h3>
        <button class="big-button manage-button" onclick="backupData()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— (JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)</button>
        <input type="file" id="restoreFile" accept=".json" style="margin-left: 10px;">
        <button class="big-button delete-button" onclick="restoreData()">ãƒªã‚¹ãƒˆã‚¢ (ä¸Šæ›¸ã)</button>
        <br>
        <button class="big-button delete-button" onclick="manualDeleteAll()" style="margin-top: 10px;">ğŸš¨ å…¨ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶å‰Šé™¤</button>
        <p style="font-size: 0.8em; color: gray; margin-top: 5px;">â€»ãƒªã‚¹ãƒˆã‚¢æ©Ÿèƒ½ã¯ã€ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¦ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã«ç½®ãæ›ãˆã¾ã™ã€‚å¤§é‡ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã®éš›ã«å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€**äºŒé‡ç™»éŒ²ã‚’é˜²ãã«ã¯ã€ãƒªã‚¹ãƒˆã‚¢å‰ã«ã€Œå…¨ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶å‰Šé™¤ã€ã‚’å®Ÿè¡Œ**ã—ã¦ãã ã•ã„ã€‚</p>
    </div>
    <hr id="backupRestoreHr" style="display: none;">
</div>
<button class="big-button" onclick="showAddForm()">æ–°è¦è¿½åŠ </button>

<hr>
<div id="classFilterContainer" style="margin-bottom: 15px;">
  </div>
<hr>

<table>
<thead>
<tr><th>å­¦ç±ç•ªå·</th><th>åå‰</th><th>ä¼šç¤¾å</th><th>çŠ¶æ³</th><th>æ—¥ä»˜</th></tr>
</thead>
<tbody id="employment-table"></tbody>
</table>
</div>

<div id="companyModal">
  <div class="inner">
    <h3>ä¼šç¤¾é¸æŠ</h3>
    <input id="companySearch" class="input-text" placeholder="ä¼šç¤¾åã¾ãŸã¯ãµã‚ŠãŒãªã§æ¤œç´¢">
    <table>
      <tbody id="companyList"></tbody>
    </table>
    <button class="big-button" onclick="closeCompanyModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// MockAPIã®URLã¯ä¸è¦ã«ãªã‚Šã¾ã—ãŸ
// const API_EMP = "https://69391958c8d59937aa067b4c.mockapi.io/employment";
// const API_COMPANY = "https://69391958c8d59937aa067b4c.mockapi.io/company";

let employment=[];
let companies=[];
let selectedId=null;
let db = null; // Firestoreã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ ¼ç´

let studentsList = []; 
let studentsMap = new Map();
let studentClassMap = new Map();
let classKeys = [];
let currentFilterClass = 'ALL'; 

let statusColors = {};

window.loginRole = null; 
window.loginStudentId = null;
window.loginStudentName = null;


// å±¥æ­´å‡¦ç†ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (å¤‰æ›´ãªã—)
function parseHistory(historyString) {
    try {
        const history = JSON.parse(historyString || '[]');
        return Array.isArray(history) ? history : [];
    } catch (e) {
        return [];
    }
}
function stringifyHistory(historyArray) {
    return JSON.stringify(historyArray);
}
function createHistoryEvent(status, date) {
    // æ—¥ä»˜ãŒç©ºã®å ´åˆã¯ä»Šæ—¥ã®æ—¥ä»˜ã‚’ä½¿ç”¨
    const eventDate = date || new Date().toISOString().split('T')[0];
    return {
        date: eventDate,
        status: status
    };
}


// â˜…â˜…â˜… FirebaseåˆæœŸåŒ– â˜…â˜…â˜…
document.addEventListener('DOMContentLoaded', async () => {
    // ã€ä»¥å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ç¢ºèªã—ãŸæ­£ã—ã„API Keyã‚’å«ã‚€Configæƒ…å ±ã‚’è¨­å®šã€‘
    const firebaseConfig = {
      apiKey: "AIzaSyDfjLJBbOBcaXxFjkOXU29dCJWwtmbv9tk",
      authDomain: "mockapi-demo.firebaseapp.com",
      projectId: "mockapi-demo",
      storageBucket: "mockapi-demo.firebasestorage.app",
      messagingSenderId: "819480407444",
      appId: "1:819480407444:web:3012c7d0bd56c907333381",
      measurementId: "G-YE6ZKLSSZC"
    };
    
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore(); 

    // åˆæœŸãƒ­ãƒ¼ãƒ‰ã«å¿…è¦ãªå‡¦ç†ã‚’awaitã§ç¢ºå®Ÿã«å®Ÿè¡Œ
    await loadStudents();
    await loadStatusColors();
    loadEmployment();
    loadCompanies();
});
// â˜…â˜…â˜… FirebaseåˆæœŸåŒ– çµ‚äº† â˜…â˜…â˜…


// loadStatusColors, loadStudents, tryLogin ãªã©ã¯å¤‰æ›´ãªã—
async function loadStatusColors() {
    try {
        const response = await fetch('status_colors.json');
        if (!response.ok) throw new Error('Failed to load status_colors.json: ' + response.statusText);
        statusColors = await response.json();
    } catch (error) {
        console.error("Error loading status colors data.", error);
    }
}

async function loadStudents() {
  try {
    const response = await fetch('students.json');
    if (!response.ok) throw new Error('Failed to load students.json: ' + response.statusText);
    
    const studentData = await response.json();

    studentsList = [];
    studentsMap = new Map();
    studentClassMap = new Map(); 
    classKeys = []; 

    for (const classKey in studentData) {
      if (Array.isArray(studentData[classKey])) {
        classKeys.push(classKey); 
        for (const student of studentData[classKey]) {
            studentsList.push(student.id);
            studentsMap.set(student.id, student.name); 
            studentClassMap.set(student.id, classKey); 
        }
      }
    }
  } catch (error) {
    console.error("Error loading students data.", error);
    document.getElementById("loginErr").textContent = "ã‚¨ãƒ©ãƒ¼: å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Webã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
  }
}

function updateUIVisibility() {
    const isStudent = window.loginRole === "student";

    const searchBox = document.getElementById("searchBox");
    const searchButton = document.getElementById("searchButton");
    const deleteButton = document.getElementById("deleteButton");
    const classFilterContainer = document.getElementById("classFilterContainer"); 
    const editSection = document.getElementById("editSection");
    const editSectionHr = document.getElementById("editSectionHr");
    const historyContainer = document.getElementById("historyContainer"); 
    const companyManageButton = document.getElementById("companyManageButton");
    
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/ãƒªã‚¹ãƒˆã‚¢é–¢é€£ã®è¦ç´ IDã‚’ä¿®æ­£
    const backupRestoreContainer = document.getElementById("backupRestoreContainer");
    const backupRestoreSection = document.getElementById("backupRestoreSection");
    const backupRestoreHr = document.getElementById("backupRestoreHr");


    if (searchBox) searchBox.style.display = isStudent ? "none" : "";
    if (searchButton) searchButton.style.display = isStudent ? "none" : "";
    if (deleteButton) deleteButton.style.display = isStudent ? "none" : "";
    
    if (classFilterContainer) classFilterContainer.style.display = isStudent ? "none" : "";
    
    // ç®¡ç†è€…ãƒ»å­¦ç”Ÿã®ä¸¡æ–¹ã§è¡¨ç¤º
    if (companyManageButton) companyManageButton.style.display = "inline-block"; 
    
    if (window.loginRole === "admin") {
        editSection.style.display = 'none';
        editSectionHr.style.display = 'none';
        if (historyContainer) historyContainer.style.display = 'none'; 
        
        // ç®¡ç†è€…ã®ã¿ã‚³ãƒ³ãƒ†ãƒŠ (ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³) ã‚’è¡¨ç¤º
        if (backupRestoreContainer) backupRestoreContainer.style.display = 'block'; 
        
        // ä¸­èº«ã¯åˆæœŸçŠ¶æ…‹ã¨ã—ã¦éè¡¨ç¤º
        if (backupRestoreSection) backupRestoreSection.style.display = 'none';
        if (backupRestoreHr) backupRestoreHr.style.display = 'none';

    } else if (window.loginRole === "student") {
        editSection.style.display = 'block';
        editSectionHr.style.display = 'block';
        if (historyContainer) historyContainer.style.display = 'none';
        
        // å­¦ç”Ÿã¯ã‚³ãƒ³ãƒ†ãƒŠå…¨ä½“ã‚’éè¡¨ç¤º
        if (backupRestoreContainer) backupRestoreContainer.style.display = 'none';
    }
    
    displayWelcomeMessage();
}

function showAddForm() {
    const editSection = document.getElementById("editSection");
    const editSectionHr = document.getElementById("editSectionHr");
    const historyContainer = document.getElementById("historyContainer");

    document.getElementById("student").value = (window.loginRole === "student" ? window.loginStudentId : "");
    document.getElementById("companyName").value = "";
    document.getElementById("statusSelect").value = "èª¬æ˜ä¼š";
    document.getElementById("date").value = "";
    selectedId = null; 

    editSection.style.display = 'block';
    editSectionHr.style.display = 'block';
    
    if (window.loginRole === "admin" && historyContainer) {
        historyContainer.style.display = 'none';
        document.getElementById("historyList").innerHTML = '';
    }
}

function displayWelcomeMessage() {
    const msgElement = document.getElementById("welcomeMessage");
    if (window.loginRole === "student" && window.loginStudentName) {
        msgElement.textContent = `ã“ã‚“ã«ã¡ã¯ ${window.loginStudentName}ã•ã‚“`;
    } else {
        msgElement.textContent = ""; 
    }
}


async function tryLogin(){
  const loginId = document.getElementById("loginId").value.trim();
  const pwInput = document.getElementById("pwInput").value.trim();
  const loginErr = document.getElementById("loginErr");

  if (studentsList.length === 0) {
      await loadStudents();
      if (studentsList.length === 0) {
          return;
      }
  }
  
  // â˜…â˜…â˜… ãƒ­ã‚°ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£é–‹å§‹ â˜…â˜…â˜…
  
  // 1. ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã®ã¯ã€IDãŒ 'admin' ã‹ã¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒ 'admin' ã®å ´åˆã®ã¿
  const isAdminId = loginId.toLowerCase() === "admin";
  const isAdminPw = pwInput === "admin" || pwInput === "ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰";
  
  if (isAdminId && isAdminPw) {
      loginErr.textContent = "";
      loginBox.style.display="none";
      app.style.display="block";
      window.loginRole = "admin";
      window.loginStudentId = loginId;
      window.loginStudentName = null; 
      
      updateUIVisibility();
      loadEmployment();
      loadCompanies();
      return;
  }

  // 2. å­¦ç”Ÿã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³
  const isStudentId = studentsList.includes(loginId);
  const isStudentPwValid = pwInput === ""; 
  
  // IDãŒå­¦ç”Ÿç•ªå·ã§ã‚ã‚Œã°ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä½•ã§ã‚ã£ã¦ã‚‚ï¼ˆç©ºã‹ã€adminã‹ã€ãã®ä»–ï¼‰å­¦ç”Ÿã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ã‚‹
  if (isStudentId) {
      loginErr.textContent = "";
      loginBox.style.display="none";
      app.style.display="block";
      
      window.loginRole = "student";
      window.loginStudentId = loginId;
      window.loginStudentName = studentsMap.get(loginId);
      
      updateUIVisibility();
      loadEmployment();
      loadCompanies();
  }
  else {
      // ã©ã¡ã‚‰ã«ã‚‚è©²å½“ã—ãªã„å ´åˆ
      loginErr.textContent = "å­¦ç±ç•ªå·ã¾ãŸã¯ç®¡ç†è€…ID/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚";
      document.getElementById("pwInput").value = "";
  }
  // â˜…â˜…â˜… ãƒ­ã‚°ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£çµ‚äº† â˜…â˜…â˜…
}

function openCompanyManager() {
    window.open('company.html', '_blank');
}


// â†“â†“â†“ æ–°ã—ã„ãƒˆã‚°ãƒ«é–¢æ•°ã‚’è¿½åŠ  â†“â†“â†“
function toggleBackupRestore() {
    if (window.loginRole !== "admin") return; 
    
    const section = document.getElementById("backupRestoreSection");
    const hr = document.getElementById("backupRestoreHr");

    if (section.style.display === 'none') {
        section.style.display = 'block';
        hr.style.display = 'block';
    } else {
        section.style.display = 'none';
        hr.style.display = 'none';
    }
}
// â†‘â†‘â†‘ æ–°ã—ã„ãƒˆã‚°ãƒ«é–¢æ•°ã‚’è¿½åŠ  â†‘â†‘â†‘


// â˜…â˜…â˜… Firestoreå¯¾å¿œ: loadEmployment (Read) â˜…â˜…â˜…
async function loadEmployment() {
  if (!db) return;
  
  try {
    const snapshot = await db.collection("employment").get();
    
    // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’é…åˆ—ã«å¤‰æ›ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’idã¨ã—ã¦ä¿æŒã€‚
    const allData = snapshot.docs.map(doc => ({
        id: doc.id, 
        ...doc.data()
    }));
    
    employment = (window.loginRole === "student")
      ? allData.filter(e => e.student === window.loginStudentId)
      : allData; 
    
    // å­¦ç±ç•ªå·é †ã‚½ãƒ¼ãƒˆ
    employment.sort((a, b) => a.student.localeCompare(b.student));
    
    if (window.loginRole === "admin") {
        currentFilterClass = 'ALL'; 
        renderClassFilters(); 
        renderTable(employment);
        document.getElementById("editSection").style.display = 'none';
        document.getElementById("editSectionHr").style.display = 'none';

    } else {
        renderTable(employment);
    }

    if (window.loginRole === "student") {
        document.getElementById("student").value = window.loginStudentId;
        document.getElementById("student").readOnly = true;
    } else {
        document.getElementById("student").readOnly = false;
    }
  } catch (error) {
      console.error("Firestoreãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ (employment):", error);
      alert("å°±è·çŠ¶æ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firebaseã®è¨­å®šã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}


function renderTable(list){
  const tb=document.getElementById("employment-table");
  tb.innerHTML="";
  list.forEach(e=>{
    const tr=document.createElement("tr");
    tr.onclick=()=>selectRow(e.id);
    
    const studentName = studentsMap.get(e.student) || "ä¸æ˜"; 
    
    tr.innerHTML=`<td>${e.student}</td><td>${studentName}</td><td>${e.companyName}</td><td>${e.status}</td><td>${e.date||""}</td>`;

    const colorInfo = statusColors[e.status];
    if (colorInfo) {
        tr.style.backgroundColor = colorInfo.background;
        tr.style.color = colorInfo.text;
    }

    tb.appendChild(tr);
  });
}

function renderHistory(historyString) {
    const historyListContainer = document.getElementById("historyList");
    const historyContainer = document.getElementById("historyContainer");
    
    if (window.loginRole !== "admin") {
        historyContainer.style.display = 'none';
        return;
    }

    historyContainer.style.display = 'block';
    historyListContainer.innerHTML = '';
    
    const historyArray = parseHistory(historyString);
    
    // æ—¥ä»˜ã®æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
    historyArray.sort((a, b) => new Date(b.date) - new Date(a.date));

    if (historyArray.length === 0) {
        historyListContainer.innerHTML = '<p style="margin: 5px;">å±¥æ­´ãªã—</p>';
        return;
    }

    const ul = document.createElement('ul');
    
    historyArray.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `[${item.date}] ${item.status}`;
        ul.appendChild(li);
    });

    historyListContainer.appendChild(ul);
    // å±¥æ­´ãƒªã‚¹ãƒˆã¯æœ€åˆã¯éè¡¨ç¤º
    historyListContainer.style.display = 'none'; 
}

function selectRow(id){
  selectedId=id;
  const e=employment.find(x=>x.id===id);
  
  document.getElementById("student").value=e.student;
  document.getElementById("companyName").value=e.companyName;
  document.getElementById("statusSelect").value=e.status;
  document.getElementById("date").value=e.date||"";

  if (window.loginRole === "admin") {
      renderHistory(e.history);
  }
  
  if (window.loginRole === "admin" || window.loginRole === "student") {
      document.getElementById("editSection").style.display = 'block';
      document.getElementById("editSectionHr").style.display = 'block';
  }
}


function renderClassFilters() {
    const container = document.getElementById("classFilterContainer");
    if (!container || window.loginRole !== "admin") return;
    
    container.innerHTML = "";
    
    const allButton = document.createElement("button");
    allButton.textContent = "ALL";
    allButton.className = "big-button";
    if (currentFilterClass === 'ALL') {
        allButton.classList.add('active-filter');
    }
    allButton.onclick = () => filterByClass('ALL');
    container.appendChild(allButton);

    classKeys.forEach(key => {
        const button = document.createElement("button");
        button.textContent = key;
        button.className = "big-button";
        if (currentFilterClass === key) {
             button.classList.add('active-filter');
        }
        button.onclick = () => filterByClass(key);
        container.appendChild(button);
    });
}

function filterByClass(classKey) {
    if (window.loginRole !== "admin") return;

    currentFilterClass = classKey;
    renderClassFilters(); 
    
    document.getElementById("editSection").style.display = 'none';
    document.getElementById("editSectionHr").style.display = 'none';
    selectedId = null; 

    let filteredEmployment = employment;

    if (classKey !== 'ALL') {
        const studentIdsInClass = Array.from(studentClassMap.entries())
            .filter(([id, cls]) => cls === classKey)
            .map(([id, cls]) => id);

        filteredEmployment = employment.filter(e => studentIdsInClass.includes(e.student));
    }

    renderTable(filteredEmployment);
}


// â˜…â˜…â˜… Firestoreå¯¾å¿œ: loadCompanies (Read) â˜…â˜…â˜…
async function loadCompanies(){
  if (!db) return;
  try {
    const snapshot = await db.collection("companies").get();
    const data = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
    }));
    companies = data; 
    renderCompanyList(data);
  } catch (error) {
    console.error("Firestoreãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ (companies):", error);
  }
}


// â˜…â˜…â˜… Firestoreå¯¾å¿œ: addEmployment (Create) â˜…â˜…â˜…
async function addEmployment(){
  const studentId = student.value;
  const company = companyName.value;

  if (window.loginRole === "student" && studentId !== window.loginStudentId) {
      alert("å­¦ç”Ÿã¯è‡ªåˆ†ã®å°±è·çŠ¶æ³ã®ã¿ã‚’è¿½åŠ ãƒ»ç·¨é›†ã§ãã¾ã™ã€‚");
      return;
  }

  const isDuplicate = employment.some(e => 
      e.student === studentId && e.companyName === company
  );
  
  if (isDuplicate) {
      alert(`ã‚¨ãƒ©ãƒ¼: å­¦ç±ç•ªå· ${studentId} ã¯æ—¢ã«ã€Œ${company}ã€ã®å°±è·çŠ¶æ³ã‚’ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚\n\nç·¨é›†ã™ã‚‹å ´åˆã¯ã€ãƒªã‚¹ãƒˆã‹ã‚‰æ—¢å­˜ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);
      return; 
  }
  
  const newStatus = statusSelect.value;
  const newDate = date.value;
  
  const initialHistory = [createHistoryEvent(newStatus, newDate)];
  const historyString = stringifyHistory(initialHistory);
  
  // Firestoreã«è¿½åŠ 
  try {
    await db.collection("employment").add({
      student:studentId,
      companyName:company,
      status:newStatus,
      date:newDate,
      history: historyString // å±¥æ­´ã‚’è¿½åŠ 
    });
    
    // æˆåŠŸå¾Œã€å†ãƒ­ãƒ¼ãƒ‰
    loadEmployment();
  } catch (error) {
    console.error("ãƒ‡ãƒ¼ã‚¿è¿½åŠ ã‚¨ãƒ©ãƒ¼:", error);
    alert("ãƒ‡ãƒ¼ã‚¿è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Firestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}

// â˜…â˜…â˜… Firestoreå¯¾å¿œ: updateEmployment (Update) â˜…â˜…â˜…
async function updateEmployment(){
  if(!selectedId)return;
  if (window.loginRole === "student" && student.value !== window.loginStudentId) {
      alert("å­¦ç”Ÿã¯è‡ªåˆ†ã®å°±è·çŠ¶æ³ã®ã¿ã‚’è¿½åŠ ãƒ»ç·¨é›†ã§ãã¾ã™ã€‚");
      return;
  }
  
  const newStatus = statusSelect.value;
  const newDate = date.value;
  
  const existingRecord = employment.find(x => x.id === selectedId);
  if (!existingRecord) return;
  
  let historyArray = parseHistory(existingRecord.history);
  
  const newHistoryEvent = createHistoryEvent(newStatus, newDate);
  
  const latestHistory = historyArray.length > 0 ? historyArray[historyArray.length - 1] : null;

  if (!latestHistory || latestHistory.status !== newStatus || latestHistory.date !== newDate) {
      historyArray.push(newHistoryEvent);
  } else {
      console.log("Status/Date not changed. History not updated.");
  }
  
  // Firestoreã‚’æ›´æ–°
  try {
    await db.collection("employment").doc(selectedId).update({
      student:student.value,
      companyName:companyName.value,
      status:newStatus,
      date:newDate,
      history: stringifyHistory(historyArray) // å±¥æ­´ã‚’æ›´æ–°
    });
    
    // æˆåŠŸå¾Œã€å†ãƒ­ãƒ¼ãƒ‰
    loadEmployment();
  } catch (error) {
    console.error("ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
    alert("ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Firestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}

// â˜…â˜…â˜… Firestoreå¯¾å¿œ: deleteEmployment (Delete) â˜…â˜…â˜…
async function deleteEmployment(){
  if(!selectedId||!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return;
  
  const e=employment.find(x=>x.id===selectedId);
  if (window.loginRole === "student" && e.student !== window.loginStudentId) {
      alert("å­¦ç”Ÿã¯è‡ªåˆ†ã®å°±è·çŠ¶æ³ã®ã¿ã‚’å‰Šé™¤ã§ãã¾ã™ã€‚");
      return;
  }
  
  // Firestoreã‹ã‚‰å‰Šé™¤
  try {
    await db.collection("employment").doc(selectedId).delete();
    // æˆåŠŸå¾Œã€å†ãƒ­ãƒ¼ãƒ‰
    loadEmployment();
  } catch (error) {
    console.error("ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
    alert("ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Firestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}


function searchEmployment(){
  const k=searchBox.value.trim();
  if(!k)return renderTable(employment);
  
  let dataToSearch;
  if (window.loginRole === "admin" && currentFilterClass !== 'ALL') {
      const studentIdsInClass = Array.from(studentClassMap.entries())
            .filter(([id, cls]) => cls === currentFilterClass)
            .map(([id, cls]) => id);
      dataToSearch = employment.filter(e => studentIdsInClass.includes(e.student));
  } else {
      dataToSearch = (window.loginRole === "student") 
          ? employment.filter(e => e.student === window.loginStudentId)
          : employment;
  }
  
  renderTable(dataToSearch.filter(e=>e.student.includes(k)));
}

function clearAll(){
  searchBox.value=""; companyName.value=""; date.value=""; 
  if (window.loginRole === "admin") {
      filterByClass('ALL');
  } else {
      renderTable(employment);
  }
}

function openCompanyModal(){
  companyModal.style.display="block";
  renderCompanyList(companies);
}
function closeCompanyModal(){ companyModal.style.display="none"; }

companySearch.oninput=()=>{
  const k = companySearch.value.trim().toLowerCase();
  
  if (!k) {
    renderCompanyList(companies);
    return;
  }
  
  const filteredList = companies.filter(c => {
    const name = c.companyName ? c.companyName.toLowerCase() : '';
    const furigana = c.furigana ? c.furigana.toLowerCase() : '';
    
    return name.includes(k) || furigana.includes(k);
  });
  
  renderCompanyList(filteredList);
};

function renderCompanyList(list){
  const tb=document.getElementById("companyList");
  tb.innerHTML="";
  list.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${c.companyName}</td>`;
    tr.onclick=()=>{ companyName.value=c.companyName; closeCompanyModal(); };
    tb.appendChild(tr);
  });
}

document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('historyToggle');
    if (toggle) {
        toggle.onclick = () => {
            const list = document.getElementById('historyList');
            list.style.display = list.style.display === 'none' ? 'block' : 'none';
        };
    }
});


// â˜…â˜…â˜… Firestoreå¯¾å¿œ: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/ãƒªã‚¹ãƒˆã‚¢æ©Ÿèƒ½ â˜…â˜…â˜…

/**
 * JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹
 */
function downloadJson(data, filename) {
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ: ${filename}`);
}

/**
 * Firestoreã‹ã‚‰å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ (Read)
 */
async function backupData() {
    // æ¨©é™ãƒã‚§ãƒƒã‚¯ã¯ãƒªã‚¹ãƒˆã‚¢/ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ã®ã¿ç®¡ç†è€…ã«é™å®š
    if (window.loginRole !== "admin" || !confirm("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å–å¾—ã—ã€JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ")) return;
    if (!db) return;
    
    try {
        const snapshot = await db.collection("employment").get();
        // Firestoreã®ãƒ‡ãƒ¼ã‚¿ã«IDã‚’å«ã‚ã¦MockAPIå½¢å¼ã«å¤‰æ›
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
        
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T-]/g, '');
        const filename = `employment_backup_${timestamp}.json`;
        
        downloadJson(data, filename);
    } catch (error) {
        alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
    }
}

/**
 * Firestoreã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’DELETEã™ã‚‹ï¼ˆå…¨ä»¶å–å¾—ã—ã€é †æ¬¡DELETEãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼‰ (Delete)
 */
async function deleteAllEmployment() {
    console.log("æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚’é–‹å§‹ã—ã¾ã™...");
    
    if (!db) return { total: 0, success: 0, fail: 0 };

    const snapshot = await db.collection("employment").get();
    const existingRecords = snapshot.docs;
    
    if (existingRecords.length === 0) {
        console.log("å‰Šé™¤å¯¾è±¡ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
        return { total: 0, success: 0, fail: 0 };
    }

    let successCount = 0;
    let failCount = 0;

    for (const doc of existingRecords) {
        try {
            await db.collection("employment").doc(doc.id).delete();
            successCount++;
        } catch (error) {
            failCount++;
            console.error(`å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ID ${doc.id}, ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }
    
    console.log(`æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†ã€‚åˆè¨ˆ: ${existingRecords.length}ä»¶, æˆåŠŸ: ${successCount}ä»¶, å¤±æ•—: ${failCount}ä»¶`);
    
    return { 
        total: existingRecords.length, 
        success: successCount, 
        fail: failCount 
    };
}

/**
 * ç®¡ç†è€…å‘ã‘ï¼šå…¨ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶å‰Šé™¤ã‚’å®Ÿè¡Œã™ã‚‹ (Delete)
 */
async function manualDeleteAll() {
    if (window.loginRole !== "admin" || !confirm("ã€æœ€çµ‚ç¢ºèªã€‘Firestoreä¸Šã®å°±è·çŠ¶æ³ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å¼·åˆ¶çš„ã«å‰Šé™¤ã—ã¾ã™ã€‚\n\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;

    const result = await deleteAllEmployment();
    
    if (result.fail > 0) {
        alert(`å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸãŒã€${result.fail}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
    } else {
        alert(`æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ ${result.total}ä»¶ ã®å‰Šé™¤ãŒã™ã¹ã¦å®Œäº†ã—ã¾ã—ãŸã€‚`);
    }
    loadEmployment();
}

/**
 * ãƒªã‚¹ãƒˆã‚¢å‡¦ç†: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤å¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ä¸€æ‹¬ç™»éŒ²ã™ã‚‹ (Delete/Create)
 */
async function restoreData() {
    if (window.loginRole !== "admin") return;
    if (!db) return;

    if (!confirm("ã€è­¦å‘Šã€‘ç¾åœ¨ã®Firestoreä¸Šã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã§ä¸Šæ›¸ããƒªã‚¹ãƒˆã‚¢ã—ã¾ã™ã€‚å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;
    
    const fileInput = document.getElementById('restoreFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert("ãƒªã‚¹ãƒˆã‚¢ã™ã‚‹JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    try {
        const fileContent = await file.text();
        const restoreDataArray = JSON.parse(fileContent);

        if (!Array.isArray(restoreDataArray)) {
            alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒé…åˆ—å½¢å¼ã®JSONã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        // 1. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
        const deleteResult = await deleteAllEmployment();
        if (deleteResult.fail > 0) {
            if (!confirm(`è­¦å‘Š: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤æ™‚ã« ${deleteResult.fail} ä»¶ã®å¤±æ•—ãŒã‚ã‚Šã¾ã—ãŸã€‚\nã“ã®ã¾ã¾ãƒªã‚¹ãƒˆã‚¢ã‚’ç¶šè¡Œã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
        }
        
        // 2. æ–°ãƒ‡ãƒ¼ã‚¿ã®ç™»éŒ²
        let postSuccessCount = 0;
        let postFailCount = 0;

        for (const record of restoreDataArray) {
            // MockAPIã®IDã¯Firestoreã§ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ä¸è¦
            const { id, ...dataToPost } = record; 
            
            try {
                // Firestoreã«add()ã§ç™»éŒ²
                await db.collection("employment").add(dataToPost);
                postSuccessCount++;
            } catch (e) {
                postFailCount++;
                console.error("ãƒªã‚¹ãƒˆã‚¢POSTå¤±æ•—:", e);
            }
        }

        let alertMessage = `ãƒªã‚¹ãƒˆã‚¢ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\næ–°è¦ãƒ‡ãƒ¼ã‚¿ç™»éŒ² æˆåŠŸ: ${postSuccessCount}ä»¶ / å¤±æ•—: ${postFailCount}ä»¶`;
        if (deleteResult.fail > 0) {
             alertMessage += `\n\nã€æ³¨æ„ã€‘æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤å¤±æ•—ãŒ ${deleteResult.fail} ä»¶ã‚ã£ãŸãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`;
        }
        alert(alertMessage);
        
        loadEmployment(); 
        
    } catch (error) {
        alert("ãƒªã‚¹ãƒˆã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„: " + error.message);
    }
}

// â˜…â˜…â˜… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/ãƒªã‚¹ãƒˆã‚¢æ©Ÿèƒ½ çµ‚äº† â˜…â˜…â˜…

// loadStudents, loadStatusColors ã¯ DOMContentLoaded å†…ã§å®Ÿè¡Œã•ã‚Œã¾ã™
</script>
</body>
</html>