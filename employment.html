<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å°±è·çŠ¶æ³ç®¡ç† (Firestoreç‰ˆ)</title>

<style>
/* æ—¢å­˜ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å®Œå…¨ã«ç¶­æŒ */
body { font-family: sans-serif; margin: 16px; }
#app { display: none; }

table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #f0f0f0; }
#employment-table tr { cursor: pointer; } 

.input-text { font-size: 16px; padding: 4px; width: 300px; margin-bottom: 6px; }
/* èª­ã¿å–ã‚Šå°‚ç”¨æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.input-text[readonly] { background-color: #f0f0f0; color: #555; cursor: not-allowed; }
.input-date { font-size: 16px; padding: 4px; }

.big-button { 
  font-size: 18px; 
  padding: 10px 20px; 
  margin-right: 10px; 
  border-radius: 6px; 
  border: none; 
  cursor: pointer; 
  background:#4CAF50; 
  color:#fff; 
  margin-bottom: 5px; 
}
.delete-button { background:#e74c3c; }
.manage-button { background: #3498db; }
.active-filter { background-color: #333 !important; }

#loginBox { max-width: 420px; margin: 80px auto; padding: 24px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }

/* æœ¬æ—¥ã®äºˆå®šç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
#todaySchedule {
    margin: 10px 0;
    padding: 12px;
    background: #fffbe6;
    border: 1px solid #ffe58f;
    border-radius: 6px;
    display: none;
}
#todaySchedule h3 { margin-top: 0; margin-bottom: 8px; font-size: 17px; color: #856404; border-bottom: 1px solid #ffe58f; padding-bottom: 4px; }
#todayList { font-weight: bold; line-height: 1.6; }

#companyModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); }
#companyModal .inner { background:#fff; max-width:600px; margin:80px auto; padding:16px; border-radius:8px; }
</style>
</head>
<body>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<div id="loginBox">
  <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
  <form onsubmit="tryLogin();return false;">
    <input id="loginId" class="input-text" placeholder="å­¦ç±ç•ªå· / ç®¡ç†è€…ID">
    <input id="pwInput" type="password" class="input-text" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <br>
    <button class="big-button" type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </form>
  <p id="loginErr" style="color:red;"></p>
</div>

<div id="app">
<h1>å°±è·çŠ¶æ³ç®¡ç†</h1>
<p id="welcomeMessage" style="margin-top: 0; font-size: 1.1em; font-weight: bold;"></p>

<div id="todaySchedule">
    <h3>ğŸ“… æœ¬æ—¥ã®äºˆå®š</h3>
    <div id="todayList"></div>
</div>

<div>
  <input id="searchBox" class="input-text" placeholder="å­¦ç±ç•ªå·ã§æ¤œç´¢">
  <button id="searchButton" class="big-button" onclick="searchEmployment()">æ¤œç´¢</button>
  <button class="big-button" onclick="clearAll()">ã‚¯ãƒªã‚¢</button>
  <button id="companyManageButton" class="big-button manage-button" onclick="openCompanyManager()">ä¼šç¤¾ç™»éŒ²</button>
</div>

<hr>
<div id="editSection" style="display:none;">
    <h3>ç™»éŒ² / ç·¨é›†</h3>
    ç”Ÿå¾’ï¼ˆå­¦ç±ç•ªå·ï¼‰<br><input id="student" class="input-text"><br>
    ä¼šç¤¾å<br><input id="companyName" class="input-text" readonly>
    <button class="big-button" onclick="openCompanyModal()">é¸æŠ</button><br>
    çŠ¶æ³<br>
    <select id="statusSelect" class="input-text">
      <option>èª¬æ˜ä¼š</option>
      <option>æ›¸é¡é¸è€ƒå¿œå‹Ÿ</option>
      <option>ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«é¢è«‡</option>
      <option>ï¼‘æ¬¡é¢æ¥äºˆå®š</option>
      <option>ï¼’æ¬¡é¢æ¥äºˆå®š</option>
      <option>æœ€çµ‚é¢æ¥äºˆå®š</option>
      <option>å†…ã€…å®š</option>
      <option>å†…å®šæ‰¿è«¾</option>
      <option>ä¸æ¡ç”¨</option>
    </select><br>
    æ—¥ä»˜<br><input type="date" id="date" class="input-date"><br><br>
    <button class="big-button" onclick="addEmployment()">è¿½åŠ </button>
    <button class="big-button" onclick="updateEmployment()">ç·¨é›†</button>
    <button id="deleteButton" class="big-button delete-button" onclick="deleteEmployment()">å‰Šé™¤</button>
</div>
<hr id="editSectionHr" style="display:none;">

<div id="backupRestoreContainer" style="display: none;">
    <button class="big-button manage-button" onclick="toggleBackupRestoreInner()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / ãƒªã‚¹ãƒˆã‚¢ (ãƒˆã‚°ãƒ«)</button>
    <div id="backupRestoreSection" style="margin-top: 10px; margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; display: none;">
        <h3>ğŸ“Š ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / ãƒªã‚¹ãƒˆã‚¢</h3>
        <button class="big-button manage-button" onclick="backupData()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
        <input type="file" id="restoreFile" accept=".json" style="margin-left: 10px;">
        <button class="big-button delete-button" onclick="restoreData()">ãƒªã‚¹ãƒˆã‚¢å®Ÿè¡Œ</button>
        <button class="big-button delete-button" onclick="manualDeleteAll()" style="margin-top: 10px;">ğŸš¨ å…¨ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶å‰Šé™¤</button>
    </div>
    <hr>
</div>

<button class="big-button" onclick="showAddForm()">æ–°è¦è¿½åŠ </button>
<hr>
<div id="classFilterContainer" style="margin-bottom: 15px;"></div>
<hr>

<table>
<thead>
<tr><th style="width: 40px;">æ–°</th><th>å­¦ç±ç•ªå·</th><th>åå‰</th><th>ä¼šç¤¾å</th><th>çŠ¶æ³</th><th>æ—¥ä»˜</th></tr>
</thead>
<tbody id="employment-table"></tbody>
</table>
</div>

<div id="companyModal">
  <div class="inner">
    <h3>ä¼šç¤¾é¸æŠ</h3>
    <input id="companySearch" class="input-text" placeholder="ä¼šç¤¾æ¤œç´¢">
    <table><tbody id="companyList"></tbody></table>
    <button class="big-button" onclick="closeCompanyModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
let employment=[]; let companies=[]; let selectedId=null; let db = null;
let studentsList = []; let studentsMap = new Map(); let studentClassMap = new Map();
let classKeys = []; let currentFilterClass = 'ALL'; let statusColors = {};
window.loginRole = null; window.loginStudentId = null;

document.addEventListener('DOMContentLoaded', async () => {
    const firebaseConfig = {
      apiKey: "AIzaSyDfjLJBbOBcaXxFjkOXU29dCJWwtmbv9tk",
      authDomain: "mockapi-demo.firebaseapp.com",
      projectId: "mockapi-demo",
      storageBucket: "mockapi-demo.firebasestorage.app",
      messagingSenderId: "819480407444",
      appId: "1:819480407444:web:3012c7d0bd56c907333381"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.firestore(); 
    await loadStudents(); await loadStatusColors(); loadEmployment(); loadCompanies();
});

async function loadStatusColors() {
    try {
        const response = await fetch('status_colors.json');
        if (response.ok) statusColors = await response.json();
    } catch (e) {}
}

async function loadStudents() {
  try {
    const response = await fetch('students.json');
    if (!response.ok) return;
    const data = await response.json();
    for (const key in data) {
      classKeys.push(key);
      data[key].forEach(s => {
          studentsList.push(s.id);
          studentsMap.set(s.id, s.name);
          studentClassMap.set(s.id, key);
      });
    }
  } catch (e) {}
}

async function loadEmployment() {
  const snapshot = await db.collection("employment").get();
  const allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  employment = (window.loginRole === "student") ? allData.filter(e => e.student === window.loginStudentId) : allData;
  employment.sort((a, b) => a.student.localeCompare(b.student));
  
  if (window.loginRole === "admin") {
      renderClassFilters();
      updateTodaySchedule();
  }
  renderTable(employment);
}

function updateTodaySchedule() {
    const container = document.getElementById("todaySchedule");
    const listDiv = document.getElementById("todayList");
    if (window.loginRole !== "admin") {
        container.style.display = "none";
        return;
    }
    const todayStr = new Date().toLocaleDateString('sv-SE');
    const todays = employment.filter(e => e.date === todayStr);

    if (todays.length > 0) {
        container.style.display = "block";
        listDiv.innerHTML = todays.map(e => `<div>ãƒ»${studentsMap.get(e.student)||"ä¸æ˜"}ã€€${e.status}ï¼ˆ${e.companyName}ï¼‰</div>`).join("");
    } else {
        container.style.display = "none";
    }
}

function renderTable(list){
  const tb=document.getElementById("employment-table"); tb.innerHTML="";
  const now = new Date();
  list.forEach(e=>{
    const tr=document.createElement("tr"); tr.onclick=()=>selectRow(e.id);
    let mark = "";
    if (e.updatedAt && e.updatedAt.toDate) {
        if ((now - e.updatedAt.toDate()) / 3600000 <= 120) mark = "â˜…";
    }
    tr.innerHTML=`<td style="color:gold;font-weight:bold;">${mark}</td><td>${e.student}</td><td>${studentsMap.get(e.student)||"?"}</td><td>${e.companyName}</td><td>${e.status}</td><td>${e.date||""}</td>`;
    if (statusColors[e.status]) {
        tr.style.backgroundColor = statusColors[e.status].background;
        tr.style.color = statusColors[e.status].text;
    }
    tb.appendChild(tr);
  });
}

async function tryLogin(){
  const id = document.getElementById("loginId").value.trim();
  const pw = document.getElementById("pwInput").value.trim();
  if (id.toLowerCase() === "admin" && (pw === "admin" || pw === "ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")) {
    window.loginRole = "admin";
  } else if (studentsList.includes(id)) {
    window.loginRole = "student"; window.loginStudentId = id;
  } else { return alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"); }
  
  document.getElementById("loginBox").style.display="none";
  document.getElementById("app").style.display="block";
  
  const isAdmin = (window.loginRole === "admin");
  const isStudent = (window.loginRole === "student");

  document.getElementById("companyManageButton").style.display = (isAdmin || isStudent) ? "inline-block" : "none";
  document.getElementById("backupRestoreContainer").style.display = isAdmin ? "block" : "none";
  document.getElementById("searchBox").style.display = isAdmin ? "inline-block" : "none";
  document.getElementById("searchButton").style.display = isAdmin ? "inline-block" : "none";
  document.getElementById("classFilterContainer").style.display = isAdmin ? "block" : "none";
  
  document.getElementById("student").readOnly = isStudent;
  document.getElementById("welcomeMessage").textContent = isAdmin ? "ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰" : `ã“ã‚“ã«ã¡ã¯ ${studentsMap.get(id)}ã•ã‚“`;
  
  loadEmployment(); loadCompanies();
}

function selectRow(id){
  selectedId=id; const e=employment.find(x=>x.id===id);
  document.getElementById("student").value=e.student;
  document.getElementById("companyName").value=e.companyName;
  document.getElementById("statusSelect").value=e.status;
  document.getElementById("date").value=e.date||"";
  document.getElementById("editSection").style.display = 'block';
  document.getElementById("editSectionHr").style.display = 'block';
}

async function addEmployment(){
  const s = document.getElementById("student").value;
  const c = document.getElementById("companyName").value;
  if(!s || !c) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
  await db.collection("employment").add({
    student:s, companyName:c, status:document.getElementById("statusSelect").value,
    date:document.getElementById("date").value, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  loadEmployment(); clearAll();
}

async function updateEmployment(){
  if(!selectedId) return;
  await db.collection("employment").doc(selectedId).update({
    student: document.getElementById("student").value, companyName: document.getElementById("companyName").value,
    status: document.getElementById("statusSelect").value, date: document.getElementById("date").value,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  loadEmployment(); clearAll();
}

async function deleteEmployment(){
  if(!selectedId || !confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  await db.collection("employment").doc(selectedId).delete();
  loadEmployment(); clearAll();
}

function showAddForm() {
  clearAll();
  document.getElementById("editSection").style.display = 'block';
  document.getElementById("editSectionHr").style.display = 'block';
}

function clearAll(){
  selectedId = null;
  document.getElementById("searchBox").value = "";
  // å­¦ç”Ÿãªã‚‰è‡ªåˆ†ã®å­¦ç±ç•ªå·ã‚’æ®‹ã™ã€ç®¡ç†è€…ãªã‚‰ç©º
  document.getElementById("student").value = (window.loginRole === "student" ? window.loginStudentId : "");
  document.getElementById("companyName").value = "";
  document.getElementById("statusSelect").selectedIndex = 0;
  document.getElementById("date").value = "";
  
  if (window.loginRole === "admin") {
      renderTable(employment);
  } else {
      renderTable(employment.filter(e => e.student === window.loginStudentId));
  }
}

function toggleBackupRestoreInner() {
    const s = document.getElementById("backupRestoreSection");
    s.style.display = (s.style.display === 'none') ? 'block' : 'none';
}

async function backupData() {
    const s = await db.collection("employment").get();
    const data = s.docs.map(doc => {
        const item = { id: doc.id, ...doc.data() };
        if (item.updatedAt && item.updatedAt.toDate) item.updatedAt = item.updatedAt.toDate().toISOString();
        return item;
    });
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `backup_${new Date().toLocaleDateString('sv-SE')}.json`; a.click();
}

async function restoreData() {
    const file = document.getElementById('restoreFile').files[0];
    if (!file || !confirm("ãƒªã‚¹ãƒˆã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
    try {
        const data = JSON.parse(await file.text());
        const s = await db.collection("employment").get();
        for (const d of s.docs) await d.ref.delete();
        for (const record of data) {
            const { id, ...dataToPost } = record;
            if (dataToPost.updatedAt) dataToPost.updatedAt = firebase.firestore.Timestamp.fromDate(new Date(dataToPost.updatedAt));
            await db.collection("employment").add(dataToPost);
        }
        alert("ãƒªã‚¹ãƒˆã‚¢å®Œäº†"); loadEmployment();
    } catch(e) { alert("ãƒªã‚¹ãƒˆã‚¢å¤±æ•—"); }
}

async function manualDeleteAll() { if (confirm("å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { const s = await db.collection("employment").get(); for (const d of s.docs) await d.ref.delete(); loadEmployment(); } }

function renderClassFilters() {
  const con = document.getElementById("classFilterContainer"); con.innerHTML = "";
  ['ALL', ...classKeys].forEach(k => {
    const b = document.createElement("button"); b.textContent = k; b.className = "big-button";
    if (currentFilterClass === k) b.classList.add('active-filter');
    b.onclick = () => { currentFilterClass = k; renderClassFilters(); renderTable(k === 'ALL' ? employment : employment.filter(e => studentClassMap.get(e.student) === k)); };
    con.appendChild(b);
  });
}

function openCompanyModal(){ document.getElementById("companyModal").style.display="block"; }
function closeCompanyModal(){ document.getElementById("companyModal").style.display="none"; }
async function loadCompanies(){
  const s = await db.collection("companies").get();
  companies = s.docs.map(d => ({ id: d.id, ...d.data() }));
  const tb = document.getElementById("companyList"); tb.innerHTML = "";
  companies.forEach(c => {
    const tr = document.createElement("tr"); tr.innerHTML = `<td>${c.companyName}</td>`;
    tr.onclick = () => { document.getElementById("companyName").value = c.companyName; closeCompanyModal(); };
    tb.appendChild(tr);
  });
}
function searchEmployment(){ const k = document.getElementById("searchBox").value.trim(); renderTable(!k ? employment : employment.filter(e => e.student.includes(k))); }
function openCompanyManager() { window.open('company.html', '_blank'); }
</script>
</body>
</html>