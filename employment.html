<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>就職状況管理</title>

<style>
body { font-family: sans-serif; margin: 16px; }
#app { display: none; }

table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; }
th { background: #f0f0f0; }

.input-text { font-size: 16px; padding: 4px; width: 300px; margin-bottom: 6px; }
.input-date { font-size: 16px; padding: 4px; }

.big-button {
  font-size: 18px;
  padding: 10px 20px;
  margin-right: 10px;
  border: none;
  border-radius: 6px;
  background: #4CAF50;
  color: white;
  cursor: pointer;
}
.delete-button { background: #e74c3c; }

#loginBox {
  max-width: 420px;
  margin: 80px auto;
  padding: 24px;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}
</style>
</head>
<body>

<!-- ログイン -->
<div id="loginBox">
  <h2>ログイン</h2>
  <p>管理者：パスワード / 学生：学籍番号のみ</p>

  <input id="loginId" class="input-text" placeholder="学籍番号">
  <input id="pwInput" type="password" class="input-text" placeholder="管理者パスワード（学生は空）">

  <br>
  <button class="big-button" onclick="tryLogin()">ログイン</button>
  <p id="loginErr" style="color:red;"></p>
</div>

<!-- メイン -->
<div id="app">

<h1>就職状況管理</h1>

<div>
  <input id="searchBox" class="input-text" placeholder="生徒番号で検索">
  <button class="big-button" onclick="searchEmployment()">検索</button>
  <button class="big-button" onclick="clearAll()">クリア</button>
  <button class="big-button" onclick="openCompanyPage()">会社登録</button>
</div>

<hr>

<h3>登録 / 編集</h3>

生徒<br>
<input id="student" class="input-text"><br>

会社名<br>
<input id="companyName" class="input-text" readonly onclick="openCompanyModal()"><br>

状況<br>
<select id="statusSelect" class="input-text">
  <option>説明会</option>
  <option>不採用</option>
  <option>書類選考応募</option>
  <option>１次面接予定</option>
  <option>２次面接予定</option>
  <option>最終面接予定</option>
  <option>内定</option>
  <option>内定承諾</option>
</select><br>

日付<br>
<input type="date" id="date" class="input-date"><br><br>

<button class="big-button" onclick="addEmployment()">追加</button>
<button class="big-button" onclick="updateEmployment()">編集</button>
<button class="big-button delete-button" onclick="deleteEmployment()">削除</button>

<hr>

<table>
<thead>
<tr>
  <th>選択</th>
  <th>生徒</th>
  <th>会社名</th>
  <th>状況</th>
  <th>日付</th>
</tr>
</thead>
<tbody id="employment-table"></tbody>
</table>

</div>

<script>
/* ===== 設定 ===== */
const API_EMP = "https://69391958c8d59937aa067b4c.mockapi.io/employment/";
const STUDENT_JSON = "students.json";
const ADMIN_HASH = "cfb075da768369ee05d64141329c41e908ea99cc88da9ee5f5d5e79ca5792d3e";

/* ===== 状態 ===== */
let loginRole = "";
let loginStudentId = "";
let employment = [];
let students = [];
let selectedId = null;

/* ===== util ===== */
async function sha256(str) {
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
  return [...new Uint8Array(buf)].map(x => x.toString(16).padStart(2, "0")).join("");
}

function getStudentName(id) {
  const s = students.find(x => x.id === id);
  return s ? s.name : "不明";
}

/* ===== 初期読み込み ===== */
fetch(STUDENT_JSON)
  .then(res => res.json())
  .then(data => students = data);

/* ===== ログイン ===== */
async function tryLogin() {
  const id = loginId.value.trim();
  const pw = pwInput.value;

  if (!id) {
    loginErr.textContent = "入力してください";
    return;
  }

  if (pw) {
    if (await sha256(pw) !== ADMIN_HASH) {
      loginErr.textContent = "パスワードが違います";
      return;
    }
    loginRole = "admin";
    student.disabled = false;
  } else {
    loginRole = "student";
    loginStudentId = id;
    student.value = id;
    student.disabled = true;
  }

  loginBox.style.display = "none";
  app.style.display = "block";

  loadEmployment();
}

/* ===== 一覧取得 ===== */
function loadEmployment() {
  fetch(API_EMP)
    .then(res => res.json())
    .then(data => {
      employment = (loginRole === "student")
        ? data.filter(e => e.student === loginStudentId)
        : data;
      renderTable(employment);
    });
}

/* ===== 表示 ===== */
function renderTable(list) {
  const tb = document.getElementById("employment-table");
  tb.innerHTML = "";

  list.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="radio" name="sel" onclick="selectRow('${e.id}')"></td>
      <td>${e.student}（${getStudentName(e.student)}）</td>
      <td>${e.companyName}</td>
      <td>${e.status}</td>
      <td>${e.date || ""}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ===== 選択 ===== */
function selectRow(id) {
  selectedId = id;
  const e = employment.find(x => x.id === id);
  student.value = e.student;
  companyName.value = e.companyName;
  statusSelect.value = e.status;
  date.value = e.date;
}

/* ===== 登録・編集 ===== */
function getForm() {
  return {
    student: (loginRole === "student") ? loginStudentId : student.value,
    companyName: companyName.value,
    status: statusSelect.value,
    date: date.value
  };
}

function addEmployment() {
  fetch(API_EMP, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(getForm())
  }).then(loadEmployment);
}

function updateEmployment() {
  if (!selectedId) return;
  fetch(API_EMP + selectedId, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(getForm())
  }).then(loadEmployment);
}

function deleteEmployment() {
  if (!selectedId) return;
  if (!confirm("削除しますか？")) return;
  fetch(API_EMP + selectedId, { method: "DELETE" })
    .then(loadEmployment);
}

/* ===== 検索・クリア ===== */
function searchEmployment() {
  const k = searchBox.value.trim();
  if (!k) return renderTable(employment);
  renderTable(employment.filter(e => e.student.includes(k)));
}

function clearAll() {
  searchBox.value = "";
  companyName.value = "";
  statusSelect.value = "説明会";
  date.value = "";
  renderTable(employment);
}

/* ===== 会社登録 ===== */
function openCompanyPage() {
  window.open("company.html", "_blank");
}
</script>

</body>
</html>
