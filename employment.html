<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>就職状況管理</title>

<style>
body { font-family: sans-serif; margin: 16px; }
#app { display: none; }

table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 10px;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
}
th { background: #f0f0f0; }

.input-text {
  font-size: 16px;
  padding: 4px;
  width: 300px;
  margin-bottom: 6px;
}
.input-date {
  font-size: 16px;
  padding: 4px;
}

.big-button {
  font-size: 18px;
  padding: 10px 20px;
  margin-right: 10px;
  border: none;
  border-radius: 6px;
  background: #4CAF50;
  color: white;
  cursor: pointer;
}
.delete-button { background: #e74c3c; }

#loginBox {
  max-width: 420px;
  margin: 80px auto;
  padding: 24px;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}

.stat-box {
  margin-top: 10px;
  padding: 10px;
  border: 1px solid #ccc;
  background: #fafafa;
}
</style>
</head>
<body>

<!-- ログイン -->
<div id="loginBox">
  <h2>ログイン</h2>
  <form onsubmit="tryLogin(); return false;">
    <input id="loginId" class="input-text" placeholder="学籍番号 / 管理者ID">
    <input id="pwInput" type="password" class="input-text" placeholder="管理者パスワード">
    <br>
    <button class="big-button" type="submit">ログイン</button>
  </form>
  <p id="loginErr" style="color:red;"></p>
</div>

<!-- メイン -->
<div id="app">

<h1>就職状況管理</h1>

<div>
  <input id="searchBox" class="input-text" placeholder="学籍番号で検索">
  <button class="big-button" onclick="searchEmployment()">検索</button>
  <button class="big-button" onclick="clearAll()">クリア</button>
  <button class="big-button" onclick="openCompanyPage()">会社登録</button>
  <button class="big-button" id="csvBtn" onclick="exportCSV()" style="display:none;">
    CSVエクスポート
  </button>
</div>

<!-- 学科フィルタ -->
<div style="margin-top:6px;" id="groupBtns">
  <button class="big-button" onclick="filterGroup(null)">全体</button>
  <button class="big-button" onclick="filterGroup('DX2')">DX2</button>
  <button class="big-button" onclick="filterGroup('JS2')">JS2</button>
  <button class="big-button" onclick="filterGroup('TEST')">TEST</button>
</div>

<!-- 内定率 -->
<div id="stats" class="stat-box" style="display:none;"></div>

<hr>

<h3>登録 / 編集</h3>

生徒<br>
<input id="student" class="input-text"><br>

会社名<br>
<input id="companyName" class="input-text"><br>

状況<br>
<select id="statusSelect" class="input-text">
  <option>説明会</option>
  <option>不採用</option>
  <option>書類選考応募</option>
  <option>１次面接予定</option>
  <option>２次面接予定</option>
  <option>最終面接予定</option>
  <option>内定</option>
  <option>内定承諾</option>
</select><br>

日付<br>
<input type="date" id="date" class="input-date"><br><br>

<button class="big-button" onclick="addEmployment()">追加</button>
<button class="big-button" onclick="updateEmployment()">編集</button>
<button class="big-button delete-button" id="deleteBtn" onclick="deleteEmployment()">削除</button>

<hr>

<table>
<thead>
<tr>
  <th>選択</th>
  <th>生徒</th>
  <th>氏名</th>
  <th>会社名</th>
  <th>状況</th>
  <th>日付</th>
</tr>
</thead>
<tbody id="employment-table"></tbody>
</table>

</div>

<script>
const API_EMP = "https://69391958c8d59937aa067b4c.mockapi.io/employment";
const STUDENT_JSON = "students.json";

/* admin/admin の SHA-256 */
const ADMIN_HASH =
"8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918";

let loginRole = "";
let loginStudentId = "";
let employment = [];
let studentsByGroup = {};
let selectedId = null;
let currentGroup = null;

/* SHA-256 */
async function sha256(str) {
  const buf = await crypto.subtle.digest(
    "SHA-256",
    new TextEncoder().encode(str)
  );
  return [...new Uint8Array(buf)]
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

/* students.json */
fetch(STUDENT_JSON)
  .then(r => r.json())
  .then(d => studentsByGroup = d);

/* ログイン */
async function tryLogin() {
  const id = loginId.value.trim();
  const pw = pwInput.value.trim();

  const h1 = await sha256(id);
  const h2 = await sha256(pw);

  if (h1 === ADMIN_HASH && h2 === ADMIN_HASH) {
    loginRole = "admin";
    student.disabled = false;
    csvBtn.style.display = "inline-block";
    stats.style.display = "block";
  } else if (/^\d+$/.test(id)) {
    loginRole = "student";
    loginStudentId = id;
    student.value = id;
    student.disabled = true;
    deleteBtn.style.display = "none";   // ← 学生は削除不可
  } else {
    loginErr.textContent = "ログイン失敗";
    return;
  }

  loginBox.style.display = "none";
  app.style.display = "block";
  loadEmployment();
}

/* 就職データ */
function loadEmployment() {
  fetch(API_EMP)
    .then(r => r.json())
    .then(data => {
      employment = (loginRole === "student")
        ? data.filter(e => e.student === loginStudentId)
        : data;
      renderTable(employment);
      if (loginRole === "admin") updateStats();
    });
}

/* 学生名 */
function getStudentName(id) {
  for (const g in studentsByGroup) {
    const s = studentsByGroup[g].find(x => x.id === id);
    if (s) return s.name;
  }
  return "";
}

/* 表示 */
function renderTable(list) {
  const tb = document.getElementById("employment-table");
  tb.innerHTML = "";

  let show = list;
  if (currentGroup) {
    const ids = (studentsByGroup[currentGroup] || []).map(s => s.id);
    show = list.filter(e => ids.includes(e.student));
  }

  show.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="radio" name="sel" onclick="selectRow('${e.id}')"></td>
      <td>${e.student}</td>
      <td>${getStudentName(e.student)}</td>
      <td>${e.companyName}</td>
      <td>${e.status}</td>
      <td>${e.date || ""}</td>
    `;
    tb.appendChild(tr);
  });
}

/* 選択 */
function selectRow(id) {
  selectedId = id;
  const e = employment.find(x => x.id === id);
  student.value = e.student;
  companyName.value = e.companyName;
  statusSelect.value = e.status;
  date.value = e.date || "";
}

/* CRUD */
function getForm() {
  return {
    student: loginRole === "student" ? loginStudentId : student.value,
    companyName: companyName.value,
    status: statusSelect.value,
    date: date.value
  };
}

function addEmployment() {
  fetch(API_EMP, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(getForm())
  }).then(loadEmployment);
}

function updateEmployment() {
  if (!selectedId) return;
  fetch(`${API_EMP}/${selectedId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(getForm())
  }).then(loadEmployment);
}

function deleteEmployment() {
  if (loginRole !== "admin") return;
  if (!selectedId) return;
  if (!confirm("削除しますか？")) return;
  fetch(`${API_EMP}/${selectedId}`, { method: "DELETE" })
    .then(loadEmployment);
}

/* 検索・クリア */
function searchEmployment() {
  const k = searchBox.value.trim();
  if (!k) return renderTable(employment);
  renderTable(employment.filter(e => e.student.includes(k)));
}

function clearAll() {
  searchBox.value = "";
  companyName.value = "";
  statusSelect.value = "説明会";
  date.value = "";
  currentGroup = null;
  renderTable(employment);
}

/* 学科 */
function filterGroup(g) {
  currentGroup = g;
  renderTable(employment);
}

/* CSV */
function exportCSV() {
  const rows = [["学籍番号","氏名","会社名","状況","日付"]];
  employment.forEach(e => {
    rows.push([
      e.student,
      getStudentName(e.student),
      e.companyName,
      e.status,
      e.date || ""
    ]);
  });

  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "employment.csv";
  a.click();
}

/* 内定率 */
function updateStats() {
  let html = "";
  for (const g in studentsByGroup) {
    const ids = studentsByGroup[g].map(s => s.id);
    const total = ids.length;
    const naitei = employment.filter(e =>
      ids.includes(e.student) &&
      (e.status === "内定" || e.status === "内定承諾")
    ).length;
    const rate = total ? Math.round(naitei / total * 100) : 0;
    html += `<b>${g}</b>：${naitei}/${total}（${rate}%）<br>`;
  }
  stats.innerHTML = html;
}

function openCompanyPage() {
  window.open("company.html", "_blank");
}
</script>
</body>
</html>
