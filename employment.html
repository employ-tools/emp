<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å°±è·çŠ¶æ³ç®¡ç† (Firestoreç‰ˆ)</title>
<style>
/* ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å®Œå…¨ã«ç¶­æŒ */
body { font-family: sans-serif; margin: 16px; }
#app { display: none; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #f0f0f0; }
#employment-table tr { cursor: pointer; } 
.input-text { font-size: 16px; padding: 4px; width: 300px; margin-bottom: 6px; }
.input-text[readonly] { background-color: #f0f0f0; color: #555; cursor: not-allowed; }
.input-date { font-size: 16px; padding: 4px; }
.big-button { font-size: 18px; padding: 10px 20px; margin-right: 10px; border-radius: 6px; border: none; cursor: pointer; background:#4CAF50; color:#fff; margin-bottom: 5px; }
.delete-button { background:#e74c3c; }
.manage-button { background: #3498db; }
.active-filter { background-color: #333 !important; }
#loginBox { max-width: 420px; margin: 80px auto; padding: 24px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
#todaySchedule { margin: 10px 0; padding: 12px; background: #fffbe6; border: 1px solid #ffe58f; border-radius: 6px; display: none; }
#todaySchedule h3 { margin-top: 0; margin-bottom: 8px; font-size: 17px; color: #856404; border-bottom: 1px solid #ffe58f; padding-bottom: 4px; }
#todayList { font-weight: bold; line-height: 1.6; }
#companyModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); }
#companyModal .inner { background:#fff; max-width:600px; margin:80px auto; padding:16px; border-radius:8px; }
/* å±¥æ­´ãƒªã‚¹ãƒˆ */
#historyList ul { list-style-type: none; padding-left: 0; margin: 0; }
#historyList li { padding: 4px 8px; border-bottom: 1px dotted #ccc; font-size: 0.9em; }
#historyList li:last-child { border-bottom: none; }
</style>
</head>
<body>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<div id="loginBox">
  <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
  <form onsubmit="tryLogin();return false;">
    <input id="loginId" class="input-text" placeholder="å­¦ç±ç•ªå· / ãƒ­ã‚°ã‚¤ãƒ³ID">
    <input id="pwInput" type="password" class="input-text" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <br>
    <button class="big-button" type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </form>
  <p id="loginErr" style="color:red;"></p>
</div>

<div id="app">
<h1>å°±è·çŠ¶æ³ç®¡ç†</h1>
<p id="welcomeMessage" style="margin-top: 0; font-size: 1.1em; font-weight: bold;"></p>

<div id="todaySchedule">
    <h3>ğŸ“… æœ¬æ—¥ã®äºˆå®š</h3>
    <div id="todayList"></div>
</div>

<div>
  <input id="searchBox" class="input-text" placeholder="å­¦ç±ç•ªå·ã§æ¤œç´¢">
  <button id="searchButton" class="big-button" onclick="searchEmployment()">æ¤œç´¢</button>
  <button class="big-button" onclick="clearAll()">ã‚¯ãƒªã‚¢</button>
  <button id="companyManageButton" class="big-button manage-button" onclick="openCompanyManager()">ä¼šç¤¾ç™»éŒ²</button>
</div>

<hr>
<div id="editSection" style="display:none;">
    <h3>ç™»éŒ² / ç·¨é›†</h3>
    ç”Ÿå¾’ï¼ˆå­¦ç±ç•ªå·ï¼‰<br><input id="student" class="input-text"><br>
    
    <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; margin-bottom:6px;">
      <div>
        ä¼šç¤¾å<br><input id="companyName" class="input-text" style="width:200px;" readonly>
        <button class="big-button" onclick="openCompanyModal()" style="padding:5px 10px; font-size:14px; margin:0;">é¸æŠ</button>
      </div>
      <div>
        çŠ¶æ³<br>
        <select id="statusSelect" class="input-text" style="width:160px;">
          <option>èª¬æ˜ä¼š</option><option>æ›¸é¡é¸è€ƒå¿œå‹Ÿ</option><option>ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«é¢è«‡</option>
          <option>ï¼‘æ¬¡é¢æ¥</option><option>ï¼’æ¬¡é¢æ¥</option><option>æœ€çµ‚é¢æ¥</option>
          <option>å†…ã€…å®š</option><option>å†…å®šæ‰¿è«¾</option><option>ä¸æ¡ç”¨</option><option>è¾é€€</option>
        </select>
      </div>
      <div>
        æ—¥ä»˜<br><input type="date" id="date" class="input-date">
      </div>
    </div>

    å‚™è€ƒ<br><textarea id="note" class="input-text" style="height:60px; width:100%; max-width:600px;"></textarea><br><br>
    <button class="big-button" onclick="addEmployment()">è¿½åŠ </button>
    <button class="big-button" onclick="updateEmployment()">ç·¨é›†</button>
    <button id="deleteButton" class="big-button delete-button" onclick="deleteEmployment()">å‰Šé™¤</button>
    <div id="historyContainer" style="margin-top: 15px; border-top: 1px solid #ccc; padding-top: 10px; display: none;">
        <h4>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å±¥æ­´ <span id="historyToggle" style="cursor: pointer; color: blue; font-size: 0.8em;">(è¡¨ç¤º/éè¡¨ç¤º)</span></h4>
        <div id="historyList" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 5px; display: none;"></div>
    </div>
</div>
<hr id="editSectionHr" style="display:none;">

<div id="backupRestoreContainer" style="display: none;">
    <button class="big-button manage-button" onclick="toggleBackupRestoreInner()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / ãƒªã‚¹ãƒˆã‚¢ (ãƒˆã‚°ãƒ«)</button>
    <div id="backupRestoreSection" style="margin-top: 10px; margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; display: none;">
        <h3>ğŸ“Š ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / ãƒªã‚¹ãƒˆã‚¢</h3>
        <button class="big-button manage-button" onclick="backupData()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
        <input type="file" id="restoreFile" accept=".json" style="margin-left: 10px;">
        <button class="big-button delete-button" onclick="restoreData()">ãƒªã‚¹ãƒˆã‚¢å®Ÿè¡Œ</button>
        <br>
        <button class="big-button delete-button" onclick="manualDeleteAll()" style="margin-top: 10px;">ğŸš¨ å…¨ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶å‰Šé™¤</button>
    </div>
    <hr>
</div>

<button class="big-button" onclick="showAddForm()">æ–°è¦è¿½åŠ </button>
<hr>
<div id="classFilterContainer" style="margin-bottom: 15px;"></div>
<hr>

<table>
<thead>
<tr><th style="width: 40px;">æ–°</th><th>å­¦ç±ç•ªå·</th><th>åå‰</th><th>ä¼šç¤¾å</th><th>çŠ¶æ³</th><th>æ—¥ä»˜</th></tr>
</thead>
<tbody id="employment-table"></tbody>
</table>
</div>

<div id="companyModal">
  <div class="inner">
    <h3>ä¼šç¤¾é¸æŠ</h3>
    <input id="companySearch" class="input-text" placeholder="ä¼šç¤¾æ¤œç´¢">
    <table><tbody id="companyList"></tbody></table>
    <button class="big-button" onclick="closeCompanyModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
async function getHash(m) {
  const d = new TextEncoder().encode(m);
  const b = await crypto.subtle.digest('SHA-256', d);
  return Array.from(new Uint8Array(b)).map(x => x.toString(16).padStart(2, '0')).join('');
}

let employment=[]; let companies=[]; let selectedId=null; let db = null;
let studentsList = []; let studentsMap = new Map(); let studentClassMap = new Map();
let classKeys = []; let currentFilterClass = 'ALL'; let statusColors = {};
window.loginRole = null; window.loginStudentId = null;

// --- Config ---
const _c1 = "QUl6YVN5RGZKTEpCYk9CYWNYeEZqa09YVTI5ZCJKV3d0bWJ2OXRr";
const _c2 = "bW9ja2FwaS1kZW1vLmZpcmViYXNlYXBwLmNvbQ==";
const _c3 = "bW9ja2FwaS1kZW1v";
const _c4 = "bW9ja2FwaS1kZW1vLmZpcmViYXNlc3RvcmFnZS5hcHA=";
const _c5 = "ODE5NDgwNDA3NDQ0";
const _c6 = "MTo4MTk0ODA0MDc0NDQ6d2ViOjMwMTJjN2QwYmQ1NmM5MDczMzMzMzgx";

document.addEventListener('DOMContentLoaded', async () => {
  try {
    const firebaseConfig = {
      apiKey: atob(_c1),
      authDomain: atob(_c2),
      projectId: atob(_c3),
      storageBucket: atob(_c4),
      messagingSenderId: atob(_c5),
      appId: atob(_c6)
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    await loadStudents(); await loadStatusColors(); loadEmployment(); loadCompanies();
  } catch (e) {
    console.error("Connection error");
  }
});

// --- Auth ---
const _k1 = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918";
const _k2 = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918";

async function tryLogin(){
  const i = document.getElementById("loginId").value.trim();
  const p = document.getElementById("pwInput").value.trim();
  const h1 = await getHash(i.toLowerCase());
  const h2 = await getHash(p);

  if (h1 === _k1 && h2 === _k2) {
    window.loginRole = "admin";
  } else if (studentsList.includes(i)) {
    window.loginRole = "student"; window.loginStudentId = i;
  } else { return alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"); }
  
  document.getElementById("loginBox").style.display="none";
  document.getElementById("app").style.display="block";
  const isAdmin = (window.loginRole === "admin");
  const isStudent = (window.loginRole === "student");
  document.getElementById("companyManageButton").style.display = "inline-block";
  document.getElementById("backupRestoreContainer").style.display = isAdmin ? "block" : "none";
  document.getElementById("searchBox").style.display = isAdmin ? "inline-block" : "none";
  document.getElementById("searchButton").style.display = isAdmin ? "inline-block" : "none";
  document.getElementById("classFilterContainer").style.display = isAdmin ? "block" : "none";
  document.getElementById("student").readOnly = isStudent;
  document.getElementById("welcomeMessage").textContent = isAdmin ? "ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰" : `ã“ã‚“ã«ã¡ã¯ ${studentsMap.get(i)}ã•ã‚“`;
  loadEmployment(); loadCompanies();
}

async function loadStatusColors() { try { const r = await fetch('status_colors.json'); if (r.ok) statusColors = await r.json(); } catch (e) {} }
async function loadStudents() { try { const r = await fetch('students.json'); if (!r.ok) return; const d = await r.json(); for (const k in d) { classKeys.push(k); d[k].forEach(s => { studentsList.push(s.id); studentsMap.set(s.id, s.name); studentClassMap.set(s.id, k); }); } } catch (e) {} }
async function loadEmployment() { if(!db) return; try { const s = await db.collection("employment").get(); const d = s.docs.map(doc => ({ id: doc.id, ...doc.data() })); employment = (window.loginRole === "student") ? d.filter(e => e.student === window.loginStudentId) : d; employment.sort((a, b) => a.student.localeCompare(b.student)); if (window.loginRole === "admin") { renderClassFilters(); updateTodaySchedule(); } renderTable(employment); } catch(e) { console.error(e); } }
function updateTodaySchedule() { const c = document.getElementById("todaySchedule"); const l = document.getElementById("todayList"); if (window.loginRole !== "admin") { c.style.display = "none"; return; } const t = new Date().toLocaleDateString('sv-SE'); const todays = employment.filter(e => e.date === t); if (todays.length > 0) { c.style.display = "block"; l.innerHTML = todays.map(e => `<div>ãƒ»${studentsMap.get(e.student)||"ä¸æ˜"}ã€€${e.status}ï¼ˆ${e.companyName}ï¼‰</div>`).join(""); } else { c.style.display = "none"; } }
function renderTable(list){ const tb=document.getElementById("employment-table"); tb.innerHTML=""; const now = new Date(); list.forEach(e=>{ const tr=document.createElement("tr"); tr.onclick=()=>selectRow(e.id); let mark = ""; if (e.updatedAt && e.updatedAt.toDate) { if ((now - e.updatedAt.toDate()) / 3600000 <= 120) mark = "â˜…"; } tr.innerHTML=`<td style="color:gold;font-weight:bold;">${mark}</td><td>${e.student}</td><td>${studentsMap.get(e.student)||"?"}</td><td>${e.companyName}</td><td>${e.status}</td><td>${e.date||""}</td>`; if (statusColors[e.status]) { tr.style.backgroundColor = statusColors[e.status].background; tr.style.color = statusColors[e.status].text; } tb.appendChild(tr); }); }
function selectRow(id){ selectedId=id; const e=employment.find(x=>x.id===id); document.getElementById("student").value=e.student; document.getElementById("companyName").value=e.companyName; document.getElementById("statusSelect").value=e.status; document.getElementById("date").value=e.date||""; document.getElementById("note").value=e.note||""; renderHistory(e.history); document.getElementById("editSection").style.display = 'block'; document.getElementById("editSectionHr").style.display = 'block'; }

function parseHistory(h) { try { const r = JSON.parse(h||'[]'); return Array.isArray(r)?r:[]; } catch(e){ return []; } }
function renderHistory(hStr) {
  const c = document.getElementById("historyContainer"); const l = document.getElementById("historyList");
  if (window.loginRole !== "admin") { c.style.display = "none"; return; }
  c.style.display = "block"; l.innerHTML = ""; l.style.display = "none";
  const arr = parseHistory(hStr); arr.sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(arr.length===0) { l.innerHTML="<p>å±¥æ­´ãªã—</p>"; return; }
  const ul=document.createElement("ul");
  arr.forEach(i=>{ const li=document.createElement("li"); li.textContent=`[${i.date}] ${i.status}`; ul.appendChild(li); });
  l.appendChild(ul);
}
document.getElementById("historyToggle").onclick = () => { const l = document.getElementById("historyList"); l.style.display = (l.style.display === 'none') ? 'block' : 'none'; };

async function addEmployment(){ 
  const s = document.getElementById("student").value; const c = document.getElementById("companyName").value; 
  if(!s || !c) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„"); 
  const st = document.getElementById("statusSelect").value; const d = document.getElementById("date").value;
  const n = document.getElementById("note").value;
  const h = JSON.stringify([{ date: d || new Date().toISOString().split('T')[0], status: st }]);
  await db.collection("employment").add({ student:s, companyName:c, status:st, date:d, note:n, history:h, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); 
  loadEmployment(); clearAll(); 
}
async function updateEmployment(){ 
  if(!selectedId) return; 
  // ç”»é¢ã®å…¥åŠ›å€¤ï¼ˆæ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ã‚’å–å¾—
  const st = document.getElementById("statusSelect").value; 
  const d = document.getElementById("date").value;
  const n = document.getElementById("note").value;
  
  const e = employment.find(x=>x.id===selectedId); 
  let arr = parseHistory(e.history);
  
  // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å±¥æ­´ã«è¿½åŠ 
  arr.push({ date: d || new Date().toISOString().split('T')[0], status: st });
  
  await db.collection("employment").doc(selectedId).update({ student: document.getElementById("student").value, companyName: document.getElementById("companyName").value, status: st, date: d, note:n, history: JSON.stringify(arr), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); 
  loadEmployment(); clearAll(); 
}
async function deleteEmployment(){ if(!selectedId || !confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return; await db.collection("employment").doc(selectedId).delete(); loadEmployment(); clearAll(); }
function showAddForm() { clearAll(); document.getElementById("editSection").style.display = 'block'; document.getElementById("editSectionHr").style.display = 'block'; document.getElementById("historyContainer").style.display = 'none'; }
function clearAll(){ selectedId = null; document.getElementById("searchBox").value = ""; document.getElementById("student").value = (window.loginRole === "student" ? window.loginStudentId : ""); document.getElementById("companyName").value = ""; document.getElementById("statusSelect").selectedIndex = 0; document.getElementById("date").value = ""; document.getElementById("note").value = ""; if (window.loginRole === "admin") { renderTable(employment); } else { renderTable(employment.filter(e => e.student === window.loginStudentId)); } }
function toggleBackupRestoreInner() { const s = document.getElementById("backupRestoreSection"); s.style.display = (s.style.display === 'none') ? 'block' : 'none'; }
async function backupData() { const s = await db.collection("employment").get(); const d = s.docs.map(doc => { const item = { id: doc.id, ...doc.data() }; if (item.updatedAt && item.updatedAt.toDate) item.updatedAt = item.updatedAt.toDate().toISOString(); return item; }); const b = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `backup_${new Date().toLocaleDateString('sv-SE')}.json`; a.click(); }
async function restoreData() { const f = document.getElementById('restoreFile').files[0]; if (!f || !confirm("ãƒªã‚¹ãƒˆã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return; try { const d = JSON.parse(await f.text()); const s = await db.collection("employment").get(); for (const doc of s.docs) await doc.ref.delete(); for (const r of d) { const { id, ...p } = r; if (p.updatedAt) p.updatedAt = firebase.firestore.Timestamp.fromDate(new Date(p.updatedAt)); await db.collection("employment").add(p); } alert("å®Œäº†"); loadEmployment(); } catch(e) { alert("å¤±æ•—"); } }
async function manualDeleteAll() { if (window.loginRole !== "admin" || !confirm("ã€æœ€çµ‚ç¢ºèªã€‘å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return; const s = await db.collection("employment").get(); for (const doc of s.docs) await doc.ref.delete(); alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"); loadEmployment(); }
function renderClassFilters() { const c = document.getElementById("classFilterContainer"); c.innerHTML = ""; ['ALL', ...classKeys].forEach(k => { const b = document.createElement("button"); b.textContent = k; b.className = "big-button"; if (currentFilterClass === k) b.classList.add('active-filter'); b.onclick = () => { currentFilterClass = k; renderClassFilters(); renderTable(k === 'ALL' ? employment : employment.filter(e => studentClassMap.get(e.student) === k)); }; c.appendChild(b); }); }
function openCompanyModal(){ document.getElementById("companyModal").style.display="block"; }
function closeCompanyModal(){ document.getElementById("companyModal").style.display="none"; }
async function loadCompanies(){ if(!db) return; const s = await db.collection("companies").get(); companies = s.docs.map(d => ({ id: d.id, ...d.data() })); const tb = document.getElementById("companyList"); tb.innerHTML = ""; companies.forEach(c => { const tr = document.createElement("tr"); tr.innerHTML = `<td>${c.companyName}</td>`; tr.onclick = () => { document.getElementById("companyName").value = c.companyName; closeCompanyModal(); }; tb.appendChild(tr); }); }
function searchEmployment(){ const k = document.getElementById("searchBox").value.trim(); renderTable(!k ? employment : employment.filter(e => e.student.includes(k))); }
function openCompanyManager() { window.open('company.html', '_blank'); }
</script>
</body>
</html>