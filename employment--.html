<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Employment 管理 (MockAPI)</title>
<style>
  body { font-family: sans-serif; margin: 16px; }
  #app { display: none; }

  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; }
  th { background-color: #f0f0f0; cursor: pointer; }

  .input-text { font-size: 16px; padding: 4px; width: 300px; margin-bottom: 6px; }
  .input-date { font-size: 16px; padding: 4px; margin-bottom: 6px; }

  .big-button {
    font-size: 18px; padding: 10px 20px; margin-right: 10px; width: 150px;
    border: none; background-color: #4CAF50; color: white;
    border-radius: 6px; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  }
  .big-button:hover { background-color: #45a049; }

  .delete-button { background-color: #e74c3c; }
  .delete-button:hover { background-color: #c0392b; }

  #companyModal { display: none; position: fixed; z-index: 30; left: 0; top: 0;
    width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
  #modalContent {
    background: white; width: 80%; max-width: 1000px; margin: 40px auto;
    padding: 20px; border-radius: 10px;
  }
  #closeModal { float:right; cursor:pointer; font-size:20px; }

  #loginBox {
    max-width: 420px; margin: 80px auto; padding: 24px; border-radius: 10px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12); background: #fff;
  }
  #loginErr { color:#c0392b; min-height:18px; }

  #topBar { display:flex; justify-content:space-between; align-items:center; gap:12px; }
</style>
</head>
<body>

<!-- ログイン画面 -->
<div id="loginBox" style="display:none;">
  <h2>ログイン</h2>
  <p>パスワードを入力してください</p>

  <input id="pwInput" type="password" class="input-text" placeholder="パスワード">

  <div style="margin-top:8px;">
    <button class="big-button" onclick="tryLogin()">ログイン</button>
    <button class="big-button delete-button" onclick="clearLoginInput()" style="width:auto;">クリア</button>
  </div>
  <p id="loginErr"></p>
</div>


<!-- アプリ本体 -->
<div id="app">

  <div id="topBar">
    <h1>Employment 管理</h1>
    <div>
      <button class="big-button" onclick="exportCSV()" style="width:auto;">CSV出力</button>
      <button class="big-button delete-button" onclick="logout()" style="width:auto;">ログアウト</button>
    </div>
  </div>

  <div style="margin-top:10px;">
    <input id="searchBox" placeholder="生徒名で検索" class="input-text" style="width:260px;">
    <button class="big-button" onclick="searchEmployment()" style="width:auto;">検索</button>
    <button class="big-button" onclick="clearAll()" style="width:auto; margin-right:20px;">クリア</button>

    <!-- 会社登録 -->
    <button class="big-button" onclick="openCompanyPage()" style="width:auto;">会社登録</button>
  </div>

  <hr>

  <h2>登録 / 編集</h2>

  生徒:<br>
  <input id="student" class="input-text"><br>

  会社名:<br>
  <input id="companyName" class="input-text" readonly onclick="openModal()" placeholder="クリックして選択"><br>

  状況:<br>
  <select id="statusSelect" class="input-text" onchange="onStatusChange()">
    <option value="">選択してください</option>
    <option value="説明会">説明会</option>
    <option value="不採用">不採用</option>
    <option value="書類選考応募">書類選考応募</option>
    <option value="１次面接予定">１次面接予定</option>
    <option value="２次面接予定">２次面接予定</option>
    <option value="最終面接予定">最終面接予定</option>
    <option value="内定">内定</option>
    <option value="内定承諾">内定承諾</option>
    <option value="その他">その他（自由入力）</option>
  </select><br>

  <input id="statusOther" class="input-text" placeholder="自由に入力" style="display:none;"><br>

  日付:<br>
  <input type="date" id="date" class="input-date"><br><br>

  <button class="big-button" onclick="addEmployment()">追加</button>
  <button class="big-button" onclick="updateEmployment()">編集</button>
  <button class="big-button delete-button" onclick="deleteEmployment()">削除</button>

  <hr>

  <table>
    <thead>
      <tr>
        <th>選択</th>
        <th onclick="sortBy('student')">生徒</th>
        <th>会社名</th>
        <th>状況</th>
        <th>日付</th>
      </tr>
    </thead>
    <tbody id="employment-table"></tbody>
  </table>

</div>

<!-- モーダル -->
<div id="companyModal">
  <div id="modalContent">
    <span id="closeModal" onclick="closeModal()">✖</span>
    <h2>会社を選択</h2>

    <input id="companySearch" placeholder="検索（会社名/ふりがな）" oninput="filterCompanies()" class="input-text">

    <table>
      <thead>
        <tr>
          <th>会社名</th>
          <th>ふりがな</th>
          <th>URL</th>
          <th>備考</th>
          <th>備考2</th>
        </tr>
      </thead>
      <tbody id="companyTable"></tbody>
    </table>
  </div>
</div>

<script>
/* ========= ログイン ========= */

const STORED_HASH = "cfb075da768369ee05d64141329c41e908ea99cc88da9ee5f5d5e79ca5792d3e"; 
const LOGIN_KEY = "employment_login_v1";

async function sha256(str) {
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
  return [...new Uint8Array(buf)].map(x => x.toString(16).padStart(2,"0")).join("");
}

async function tryLogin() {
  const pw = document.getElementById("pwInput").value;
  const hash = await sha256(pw);
  if (hash === STORED_HASH) {
    localStorage.setItem(LOGIN_KEY, "1");
    showApp();
  } else {
    document.getElementById("loginErr").innerText = "パスワードが違います";
  }
}

document.getElementById("pwInput").addEventListener("keydown", e => {
  if (e.key === "Enter") tryLogin();
});

function clearLoginInput() {
  document.getElementById("pwInput").value = "";
  document.getElementById("loginErr").innerText = "";
}

function logout() {
  localStorage.removeItem(LOGIN_KEY);
  hideApp();
}

function showApp() {
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("app").style.display = "block";
  loadEmployment();
}
function hideApp() {
  document.getElementById("app").style.display = "none";
  document.getElementById("loginBox").style.display = "block";
}

function checkLoginOnLoad() {
  if (localStorage.getItem(LOGIN_KEY) === "1") showApp();
  else document.getElementById("loginBox").style.display = "block";
}

/* ========= Employment CRUD ========= */

const API_EMP = "https://69391958c8d59937aa067b4c.mockapi.io/employment/";
const API_COMPANY = "https://69391958c8d59937aa067b4c.mockapi.io/company/";

let employment = [];
let companies = [];
let selectedId = null;
let sortKey = "student";
let sortAsc = true;

function loadEmployment() {
  fetch(API_EMP)
    .then(r=>r.json())
    .then(d=>{ employment=d; renderEmploymentTable(d); });
}

function renderEmploymentTable(list) {
  const tbody = document.getElementById("employment-table");
  tbody.innerHTML = "";

  list.sort((a,b) => {
    let A=a[sortKey]||"", B=b[sortKey]||"";
    return sortAsc ? A.localeCompare(B) : B.localeCompare(A);
  });

  list.forEach(e=>{
    const tr=document.createElement("tr");

    if (e.status==="内定") tr.style.background="#ccffcc";
    if (e.status==="不採用") tr.style.background="#e0e0e0";
    if (e.status==="内定承諾") tr.style.background="#99ff99";

    tr.innerHTML = `
      <td><input type="radio" name="sel" onclick="selectEmployment('${e.id}')"></td>
      <td>${e.student}</td>
      <td>${e.companyName}</td>
      <td>${e.status}</td>
      <td>${e.date}</td>
    `;
    tbody.appendChild(tr);
  });
}

function selectEmployment(id) {
  selectedId = id;
  const e = employment.find(x=>x.id===id);
  document.getElementById("student").value = e.student;
  document.getElementById("companyName").value = e.companyName;

  if ([...document.getElementById("statusSelect").options].some(o=>o.value===e.status)) {
    document.getElementById("statusSelect").value = e.status;
    document.getElementById("statusOther").style.display="none";
  } else {
    document.getElementById("statusSelect").value = "その他";
    document.getElementById("statusOther").style.display="block";
    document.getElementById("statusOther").value = e.status;
  }

  document.getElementById("date").value = e.date;
}

function onStatusChange() {
  const val = document.getElementById("statusSelect").value;
  document.getElementById("statusOther").style.display = (val==="その他")?"block":"none";
}

function getFormValues() {
  const sel = document.getElementById("statusSelect").value;
  const other = document.getElementById("statusOther").value;
  return {
    student: document.getElementById("student").value.trim(),
    companyName: document.getElementById("companyName").value.trim(),
    status: (sel==="その他"? other : sel),
    date: document.getElementById("date").value
  };
}

function addEmployment() {
  const data = getFormValues();
  if (!data.student) return alert("生徒名を入力");
  if (!data.companyName) return alert("会社名を選択");

  fetch(API_EMP,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  }).then(loadEmployment);
}

function updateEmployment() {
  if (!selectedId) return alert("選択されていません");

  fetch(API_EMP+selectedId,{
    method:"PUT",headers:{"Content-Type":"application/json"},
    body:JSON.stringify(getFormValues())
  }).then(loadEmployment);
}

function deleteEmployment() {
  if (!selectedId) return alert("選択されていません");
  if (!confirm("本当に削除しますか？")) return;

  fetch(API_EMP+selectedId,{method:"DELETE"}).then(loadEmployment);
}

function searchEmployment() {
  const key = document.getElementById("searchBox").value.trim();
  if (!key) return renderEmploymentTable(employment);
  renderEmploymentTable(employment.filter(e=>e.student.includes(key)));
}

function clearAll() {
  document.getElementById("searchBox").value="";
  document.getElementById("student").value="";
  document.getElementById("companyName").value="";
  document.getElementById("statusSelect").value="";
  document.getElementById("statusOther").style.display="none";
  document.getElementById("statusOther").value="";
  document.getElementById("date").value="";
  selectedId=null;
  renderEmploymentTable(employment);
}

function sortBy(key){
  if (sortKey===key) sortAsc=!sortAsc;
  else { sortKey=key; sortAsc=true; }
  renderEmploymentTable(employment);
}

/* ========= Company モーダル ========= */

function openModal() {
  document.getElementById("companyModal").style.display="block";
  loadCompanies();
}
function closeModal() {
  document.getElementById("companyModal").style.display="none";
}

function loadCompanies() {
  fetch(API_COMPANY)
    .then(r=>r.json())
    .then(d=>{ companies=d; renderCompanyTable(d); });
}

function renderCompanyTable(list) {
  const tbody=document.getElementById("companyTable");
  tbody.innerHTML="";
  list.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td><span style="color:blue; cursor:pointer;" onclick="selectCompany('${c.companyName}')">${c.companyName}</span></td>
      <td>${c.furigana||""}</td>
      <td><a href="${c.url}" target="_blank">${c.url}</a></td>
      <td>${c.etc||""}</td>
      <td>${c.etc2||""}</td>
    `;
    tbody.appendChild(tr);
  });
}

function filterCompanies() {
  const key=document.getElementById("companySearch").value.trim();
  renderCompanyTable(companies.filter(c =>
    c.companyName.includes(key) ||
    (c.furigana||"").includes(key)
  ));
}

function selectCompany(name) {
  document.getElementById("companyName").value=name;
  closeModal();
}

/* ========= CSV 出力 ========= */

function exportCSV() {
  let csv="生徒,会社名,状況,日付\n";
  employment.forEach(e=>{
    csv+=`"${e.student}","${e.companyName}","${e.status}","${e.date}"\n`;
  });

  const bom=new Uint8Array([0xEF,0xBB,0xBF]);
  const blob=new Blob([bom,csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="employment.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* ========= 会社登録ボタン ========= */
function openCompanyPage() {
  window.open("company.html", "_blank");
}

/* 起動時ログイン確認 */
checkLoginOnLoad();
</script>
</body>
</html>
