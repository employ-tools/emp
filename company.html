<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Company ç®¡ç†ç”»é¢ v1.110 (Firestoreç‰ˆ)</title>
  <style>
    /* ãƒ‡ã‚¶ã‚¤ãƒ³ã¯çµ¶å¯¾ã«ãã®ã¾ã¾ */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background-color: #f0f0f0;
      cursor: pointer;
    }
    tr:hover {
      background-color: #fafafa;
    }

    /* åˆ—å¹…èª¿æ•´ */
    th:nth-child(2), td:nth-child(2) { width: 20%; } /* ä¼šç¤¾å */
    th:nth-child(3), td:nth-child(3) { width: 20%; } /* ãµã‚ŠãŒãª */
    th:nth-child(4), td:nth-child(4) { width: 20%; } /* URL */
    th:nth-child(5), td:nth-child(5) { width: 40%; } /* å‚™è€ƒ */

    /* å…¥åŠ›æ¬„ã‚¹ã‚¿ã‚¤ãƒ« */
    .input-text {
      font-size: 16px;
      padding: 4px;
      width: 350px;
      margin-bottom: 6px;
    }
    .input-area {
      font-size: 16px;
      padding: 6px;
      width: 350px;
      height: 70px;
      margin-bottom: 6px;
    }

    /* ãƒœã‚¿ãƒ³å¤§å‹åŒ– */
    .big-button {
      font-size: 18px;
      padding: 10px 20px;
      margin-right: 10px;
      width: 120px;
      border: none;
      background-color: #4CAF50;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    .big-button:hover { background-color: #45a049; }

    .delete-button { background-color: #e74c3c; }
    .delete-button:hover { background-color: #c0392b; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #modalOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #modalWindow {
      background: white;
      padding: 20px;
      width: 400px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    #modalClose {
      float: right;
      cursor: pointer;
      font-size: 20px;
    }
  </style>
</head>
<body>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<h1>Company ç®¡ç†</h1>

<input id="searchBox" placeholder="ä¼šç¤¾åã§æ¤œç´¢">
<button class="big-button" onclick="searchCompanies()">æ¤œç´¢</button>

<hr>

<h2>ç™»éŒ² / ç·¨é›†</h2>

ä¼šç¤¾å:<br>
<input id="companyName" class="input-text"><br>

ãµã‚ŠãŒãª:<br>
<input id="furigana" class="input-text"><br>

URL:<br>
<input id="url" class="input-text"><br>

å‚™è€ƒ etc:<br>
<input id="etc" class="input-text"><br>

å‚™è€ƒ2 etc2:<br>
<textarea id="etc2" class="input-area"></textarea><br><br>

<button class="big-button" onclick="addCompany()">è¿½åŠ </button>
<button class="big-button" onclick="updateCompany()">ç·¨é›†</button>
<button class="big-button delete-button" onclick="deleteSelected()">å‰Šé™¤</button>

<hr>

<table>
  <thead>
    <tr>
      <th>é¸æŠ</th>
      <th onclick="sortBy('companyName')">ä¼šç¤¾å</th>
      <th onclick="sortBy('furigana')">ãµã‚ŠãŒãª</th>
      <th>URL</th>
      <th>å‚™è€ƒ</th>
    </tr>
  </thead>
  <tbody id="company-table"></tbody>
</table>

<div id="modalOverlay" onclick="closeModal()">
  <div id="modalWindow" onclick="event.stopPropagation()">
    <span id="modalClose" onclick="closeModal()">Ã—</span>
    <h2 id="modalTitle"></h2>

    <p><strong>ãµã‚ŠãŒãª:</strong><br><span id="modalFurigana"></span></p>
    <p><strong>URL:</strong><br><span id="modalUrl"></span></p>
    <p><strong>å‚™è€ƒ etc:</strong><br><span id="modalEtc"></span></p>
    <p><strong>å‚™è€ƒ2 etc2:</strong><br><span id="modalEtc2"></span></p>
  </div>
</div>

<script>
// MockAPI URLã‚’å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
// const API_URL = "https://69391958c8d59937aa067b4c.mockapi.io/company/";

let companies = [];
let selectedId = null;
let db = null; // ã€ä¿®æ­£æ¸ˆã¿ã€‘ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ db ã‚’å®šç¾©

/* ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ä¿æŒ */
let sortKey = "companyName";
let sortAsc = true;


// â˜…â˜…â˜… FirebaseåˆæœŸåŒ– â˜…â˜…â˜…
document.addEventListener('DOMContentLoaded', () => {
    // ã€ã”æä¾›ã„ãŸã ã„ãŸæ­£ã—ã„API Keyã‚’å«ã‚€Configæƒ…å ±ã‚’è¨­å®šã€‘
    const firebaseConfig = {
      apiKey: "AIzaSyDfjLJBbOBcaXxFjkOXU29dCJWwtmbv9tk",
      authDomain: "mockapi-demo.firebaseapp.com",
      projectId: "mockapi-demo",
      storageBucket: "mockapi-demo.firebasestorage.app",
      messagingSenderId: "819480407444",
      appId: "1:819480407444:web:3012c7d0bd56c907333381",
      measurementId: "G-YE6ZKLSSZC"
    };
    
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore(); // ã€ä¿®æ­£æ¸ˆã¿ã€‘ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° db ã«ä»£å…¥

    loadCompanies(); // åˆæœŸãƒ­ãƒ¼ãƒ‰ã‚’FirebaseåˆæœŸåŒ–å¾Œã«å®Ÿè¡Œ
});
// â˜…â˜…â˜… FirebaseåˆæœŸåŒ– çµ‚äº† â˜…â˜…â˜…


/* --- ä¸€è¦§å–å¾— (Firestoreå¯¾å¿œ) --- */
async function loadCompanies() {
  if (!db) return; // DBãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å‡¦ç†ã—ãªã„
  
  try {
    const snapshot = await db.collection("companies").get();
    
    // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’é…åˆ—ã«å¤‰æ›ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’idã¨ã—ã¦ä¿æŒã€‚
    companies = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data() // companyName, furigana, url, etc, etc2 ãŒå«ã¾ã‚Œã‚‹
    }));
    
    renderTable(companies);
  } catch (error) {
    console.error("Firestoreãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    alert("ä¼šç¤¾ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firebaseã®è¨­å®šã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}

/* --- ãƒ†ãƒ¼ãƒ–ãƒ«æç”» --- */
function renderTable(list) {
  const tbody = document.getElementById("company-table");
  tbody.innerHTML = "";

  list.sort((a, b) => {
    const A = a[sortKey] || "";
    const B = b[sortKey] || "";
    return sortAsc ? A.localeCompare(B) : B.localeCompare(A);
  });

  list.forEach(c => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td><input type="radio" name="select" onclick="selectCompany('${c.id}')"></td>

      <td style="color:blue; text-decoration:underline; cursor:pointer;"
          onclick="openModal('${c.id}')">${c.companyName}</td>

      <td>${c.furigana || ""}</td>

      <td>
        <a href="${c.url}" target="_blank" style="color:#0066cc;">
          ${c.url}
        </a>
      </td>

      <td>${c.etc}</td>
    `;

    tbody.appendChild(tr);
  });
}

/* --- ãƒ©ã‚¸ã‚ªé¸æŠ â†’ å…¥åŠ›åæ˜  --- */
function selectCompany(id) {
  selectedId = id;
  const c = companies.find(x => x.id === id);

  document.getElementById("companyName").value = c.companyName;
  document.getElementById("furigana").value = c.furigana || "";
  document.getElementById("url").value = c.url;
  document.getElementById("etc").value = c.etc;
  document.getElementById("etc2").value = c.etc2 || "";
}

/* --- ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º --- */
function openModal(id) {
  const c = companies.find(x => x.id === id);

  document.getElementById("modalTitle").textContent = c.companyName;
  document.getElementById("modalFurigana").textContent = c.furigana || "(ãªã—)";
  document.getElementById("modalUrl").innerHTML =
    c.url ? `<a href="${c.url}" target="_blank">${c.url}</a>` : "(ãªã—)";
  document.getElementById("modalEtc").textContent = c.etc || "(ãªã—)";
  document.getElementById("modalEtc2").textContent = c.etc2 || "(ãªã—)";

  document.getElementById("modalOverlay").style.display = "flex";
}
function closeModal() {
  document.getElementById("modalOverlay").style.display = "none";
}

/* --- è¿½åŠ  (Firestoreå¯¾å¿œ) --- */
async function addCompany() {
  const data = getFormValues();

  if (!data.companyName) return alert("ä¼šç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  // é‡è¤‡ãƒã‚§ãƒƒã‚¯: æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆã«å¯¾ã—ã¦ãƒã‚§ãƒƒã‚¯
  if (companies.some(c => c.companyName === data.companyName))
    return alert("åŒã˜ä¼šç¤¾åãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™");

  try {
    // Firestoreã«è¿½åŠ 
    // measurementIdã¯ãƒ‡ãƒ¼ã‚¿ã«ã¯ä¸è¦ãªã®ã§ã€é™¤å¤–ã—ã¦ç™»éŒ²
    const { measurementId, ...dataToSave } = data;
    await db.collection("companies").add(dataToSave); 
    
    // è¿½åŠ æˆåŠŸå¾Œã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†ãƒ­ãƒ¼ãƒ‰
    clearForm();
    loadCompanies();
  } catch (error) {
    console.error("ãƒ‡ãƒ¼ã‚¿è¿½åŠ ã‚¨ãƒ©ãƒ¼:", error);
    alert("ãƒ‡ãƒ¼ã‚¿è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nè©³ç´°: " + error.message + "\n\nğŸš¨åŸå› ã®å¯èƒ½æ€§: Firestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ãŒæ›¸ãè¾¼ã¿ã‚’è¨±å¯ã—ã¦ã„ã¾ã›ã‚“ã€‚");
  }
}

/* --- ç·¨é›† (Firestoreå¯¾å¿œ) --- */
async function updateCompany() {
  if (!selectedId) return alert("ç·¨é›†ã™ã‚‹ä¼šç¤¾ã‚’é¸ã‚“ã§ãã ã•ã„");

  const data = getFormValues();

  if (companies.some(c =>
      c.companyName === data.companyName && c.id !== selectedId))
    return alert("åŒã˜ä¼šç¤¾åãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™");

  try {
    // Firestoreã‚’æ›´æ–°
    const { measurementId, ...dataToSave } = data;
    await db.collection("companies").doc(selectedId).update(dataToSave);
    
    // æ›´æ–°æˆåŠŸå¾Œã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†ãƒ­ãƒ¼ãƒ‰
    clearForm();
    loadCompanies();
  } catch (error) {
    console.error("ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
    alert("ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nğŸš¨åŸå› ã®å¯èƒ½æ€§: Firestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ãŒæ›¸ãè¾¼ã¿ã‚’è¨±å¯ã—ã¦ã„ã¾ã›ã‚“ã€‚");
  }
}

/* --- å‰Šé™¤ (Firestoreå¯¾å¿œ) --- */
async function deleteSelected() {
  if (!selectedId) return alert("å‰Šé™¤ã™ã‚‹ä¼šç¤¾ã‚’é¸ã‚“ã§ãã ã•ã„");
  if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  try {
    // Firestoreã‹ã‚‰å‰Šé™¤
    await db.collection("companies").doc(selectedId).delete();
    
    // å‰Šé™¤æˆåŠŸå¾Œã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†ãƒ­ãƒ¼ãƒ‰
    clearForm();
    loadCompanies();
  } catch (error) {
    console.error("ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
    alert("ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nğŸš¨åŸå› ã®å¯èƒ½æ€§: Firestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ãŒæ›¸ãè¾¼ã¿ã‚’è¨±å¯ã—ã¦ã„ã¾ã›ã‚“ã€‚");
  }
}

/* --- å…¥åŠ›æ¬„ã‹ã‚‰å€¤ã‚’ã¾ã¨ã‚ã‚‹ --- */
function getFormValues() {
  return {
    companyName: document.getElementById("companyName").value.trim(),
    furigana: document.getElementById("furigana").value.trim(),
    url: document.getElementById("url").value.trim(),
    etc: document.getElementById("etc").value.trim(),
    etc2: document.getElementById("etc2").value.trim()
  };
}

/* --- ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢ --- */
function clearForm() {
  document.getElementById("companyName").value = "";
  document.getElementById("furigana").value = "";
  document.getElementById("url").value = "";
  document.getElementById("etc").value = "";
  document.getElementById("etc2").value = "";
  selectedId = null; 

  // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®é¸æŠã‚’è§£é™¤ (å¿µã®ãŸã‚)
  document.querySelectorAll('input[name="select"]').forEach(radio => radio.checked = false);
}

/* --- æ¤œç´¢ --- */
function searchCompanies() {
  const key = document.getElementById("searchBox").value.trim();
  if (!key) return renderTable(companies);

  // ãµã‚ŠãŒãªã§ã®æ¤œç´¢ã‚‚å¯èƒ½ã«ã™ã‚‹ãŸã‚ã€å°æ–‡å­—åŒ–ã—ã¦æ¤œç´¢
  const searchKey = key.toLowerCase();
  
  renderTable(
    companies.filter(c => 
        (c.companyName && c.companyName.toLowerCase().includes(searchKey)) ||
        (c.furigana && c.furigana.toLowerCase().includes(searchKey))
    )
  );
}

/* --- ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ --- */
function sortBy(key) {
  if (sortKey === key) sortAsc = !sortAsc;
  else {
    sortKey = key;
    sortAsc = true;
  }
  renderTable(companies);
}

</script>

</body>
</html>